import React, { useState } from 'react'
import { motion } from 'framer-motion'
import { Card, CardContent } from "@/components/ui/card"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from "@/components/ui/select"
import { Progress } from "@/components/ui/progress"
import { Toggle } from "@/components/ui/toggle"
import { Download, UploadCloud, RefreshCw } from 'lucide-react'
import { ResponsiveContainer, LineChart, Line, XAxis, YAxis, Tooltip } from 'recharts'

export default function UiOptimizationDashboard() {
  const [screenshot, setScreenshot] = useState(null)
  const [preset, setPreset] = useState('accessibility')
  const [suggestions, setSuggestions] = useState(sampleSuggestions)
  const [optimizedPreview, setOptimizedPreview] = useState(null)
  const [running, setRunning] = useState(false)
  const [improvementScore, setImprovementScore] = useState(12)

  function handleUpload(e) {
    const file = e.target.files?.[0]
    if (!file) return
    const url = URL.createObjectURL(file)
    setScreenshot(url)
    setOptimizedPreview(null)
    setSuggestions(sampleSuggestions)
    setImprovementScore(12)
  }

  function runOptimization() {
    setRunning(true)
    setTimeout(() => {
      // mock results
      setOptimizedPreview(screenshot || '/placeholder-optimized.png')
      setSuggestions(prev => prev.map((s, i) => ({ ...s, done: i < 2 })))
      setImprovementScore(prev => Math.min(95, prev + 34))
      setRunning(false)
    }, 1400)
  }

  function applySuggestion(index) {
    setSuggestions(prev => prev.map((s,i) => i===index?{...s, done: true}:s))
    setImprovementScore(prev => Math.min(100, prev + 6))
  }

  return (
    <div className="p-6 max-w-6xl mx-auto">
      <div className="flex items-center justify-between mb-6">
        <div>
          <h1 className="text-2xl font-semibold">UI Optimization Studio</h1>
          <p className="text-sm text-slate-500">Upload a screen and get prioritized UI suggestions, quick fixes and exportable assets.</p>
        </div>
        <div className="flex gap-2">
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="file" accept="image/*" onChange={handleUpload} className="hidden" />
            <Button variant="ghost"><UploadCloud className="w-4 h-4 mr-2" /> Upload Screen</Button>
          </label>
          <Button onClick={() => { setScreenshot(null); setOptimizedPreview(null); setSuggestions(sampleSuggestions); setImprovementScore(12) }}><RefreshCw className="w-4 h-4 mr-2"/> Reset</Button>
        </div>
      </div>

      <div className="grid grid-cols-12 gap-6">
        <aside className="col-span-4">
          <Card className="mb-4">
            <CardContent>
              <div className="mb-3 flex items-center justify-between">
                <div>
                  <h3 className="text-lg font-medium">Run Options</h3>
                  <p className="text-xs text-slate-500">Choose presets and priorities</p>
                </div>
              </div>

              <div className="space-y-3">
                <div>
                  <label className="text-sm text-slate-600">Preset</label>
                  <Select onValueChange={(v)=>setPreset(v)} defaultValue={preset}>
                    <SelectTrigger className="w-full mt-1"><SelectValue /></SelectTrigger>
                    <SelectContent>
                      <SelectItem value="accessibility">Accessibility</SelectItem>
                      <SelectItem value="performance">Performance</SelectItem>
                      <SelectItem value="usability">Usability</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <label className="text-sm text-slate-600">Target improvement</label>
                  <Progress value={improvementScore} className="mt-2" />
                  <div className="text-xs text-slate-500 mt-1">Estimated improvement: {improvementScore}%</div>
                </div>

                <div className="flex items-center justify-between mt-2">
                  <div className="text-sm">Auto-apply minor fixes</div>
                  <Toggle defaultChecked />
                </div>

                <div className="mt-4">
                  <Button onClick={runOptimization} disabled={running || !screenshot}>{running? 'Optimizing...' : 'Run Optimization'}</Button>
                </div>
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent>
              <h4 className="text-sm font-medium mb-2">Quick Metrics</h4>
              <div className="grid grid-cols-2 gap-3">
                <small className="text-xs text-slate-500">Contrast Issues</small>
                <div className="font-semibold">7</div>
                <small className="text-xs text-slate-500">Tap Targets</small>
                <div className="font-semibold">4</div>
                <small className="text-xs text-slate-500">Load Score</small>
                <div className="font-semibold">82</div>
                <small className="text-xs text-slate-500">A11y Score</small>
                <div className="font-semibold">68</div>
              </div>
            </CardContent>
          </Card>
        </aside>

        <main className="col-span-8">
          <div className="grid grid-cols-2 gap-4 mb-4">
            <Card>
              <CardContent>
                <h4 className="text-sm font-medium mb-2">Original</h4>
                <div className="h-64 bg-slate-50 border rounded overflow-hidden flex items-center justify-center">
                  {screenshot ? <img src={screenshot} alt="original" className="max-h-full"/> : <div className="text-slate-400">No screen uploaded</div>}
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent>
                <div className="flex items-start justify-between">
                  <h4 className="text-sm font-medium">Optimized</h4>
                  <div className="text-xs text-slate-500">Preview</div>
                </div>
                <div className="h-64 bg-slate-50 border rounded overflow-hidden mt-3 flex items-center justify-center">
                  {optimizedPreview ? <img src={optimizedPreview} alt="optimized" className="max-h-full"/> : <div className="text-slate-400">No preview yet</div>}
                </div>
                <div className="flex gap-2 mt-3">
                  <Button variant="ghost"><Download className="w-4 h-4 mr-2"/> Export</Button>
                </div>
              </CardContent>
            </Card>
          </div>

          <Card>
            <CardContent>
              <div className="flex items-center justify-between mb-3">
                <h4 className="text-sm font-medium">Suggestions</h4>
                <div className="text-xs text-slate-500">Prioritized & actionable</div>
              </div>

              <div className="space-y-3">
                {suggestions.map((s, i) => (
                  <motion.div key={i} initial={{opacity:0,y:6}} animate={{opacity:1,y:0}} className={`p-3 border rounded flex items-start justify-between ${s.done? 'bg-green-50 border-green-100':''}`}>
                    <div>
                      <div className="text-sm font-medium">{s.title}</div>
                      <div className="text-xs text-slate-500">{s.desc}</div>
                    </div>
                    <div className="flex flex-col items-end gap-2">
                      <div className="text-xs text-slate-500">Impact: {s.impact}</div>
                      {!s.done ? <Button size="sm" onClick={()=>applySuggestion(i)}>Apply</Button> : <div className="text-xs text-green-600">Applied</div>}
                    </div>
                  </motion.div>
                ))}
              </div>
            </CardContent>
          </Card>

          <div className="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
            <Card>
              <CardContent>
                <h4 className="text-sm font-medium mb-2">Improvement Over Time</h4>
                <div style={{width: '100%', height: 160}}>
                  <ResponsiveContainer>
                    <LineChart data={chartData}>
                      <XAxis dataKey="step" />
                      <YAxis />
                      <Tooltip />
                      <Line type="monotone" dataKey="score" stroke="#4f46e5" strokeWidth={2} />
                    </LineChart>
                  </ResponsiveContainer>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent>
                <h4 className="text-sm font-medium mb-2">Export & Integrations</h4>
                <div className="flex flex-col gap-2">
                  <Button variant="outline">Export annotated PNG</Button>
                  <Button variant="outline">Export accessibility report (CSV)</Button>
                  <Button variant="outline">Send to Figma</Button>
                </div>
              </CardContent>
            </Card>
          </div>
        </main>
      </div>
    </div>
  )
}


// ----- Mock data -----
const sampleSuggestions = [
  { title: 'Increase CTA contrast', desc: 'Primary button contrast below recommended ratio.', impact: 'High', done: false },
  { title: 'Increase tap target size', desc: 'Small touch targets on key actions.', impact: 'Medium', done: false },
  { title: 'Reduce dense text blocks', desc: 'Break long paragraphs, improve scanability.', impact: 'Low', done: false },
  { title: 'Compress hero image', desc: 'Large images increase load times for mobile.', impact: 'Medium', done: false },
]

const chartData = [
  { step: 'Start', score: 12 },
  { step: 'Auto-fix', score: 38 },
  { step: 'Apply suggestions', score: 56 },
  { step: 'Final', score: 78 },
]
