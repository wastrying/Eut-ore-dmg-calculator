<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sign Up | Remblyx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="../images/medisignal.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../images/medisignal.png">
  <link rel="apple-touch-icon" href="../images/medisignal.png">

  <!-- Flaticon icons -->
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
    body {
      background: #f5f5f5; min-height: 100vh; display: flex; justify-content: center; align-items: center;
      position: relative; overflow: hidden; padding: 16px;
    }
    .overlay { position: fixed; inset: 0; z-index: -1; }
    .bg-image { width: 100%; height: 100%; object-fit: cover; filter: blur(4px); opacity: 0.8; }
    .header-row { position: fixed; top: -27px; left: 8px; z-index: 20; }
    .logo { height: 200px; cursor: pointer; transition: 0.3s ease; }
    .logo:hover { filter: brightness(1.05); transform: scale(1.02); }

    .container {
      background: rgba(255, 255, 255, 0.97); border-radius: 16px; padding: 22px 20px 20px;
      width: 100%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.18); z-index: 10;
      text-align: center; margin: 0; max-height: calc(100vh - 80px); overflow-y: auto;
    }
    h2 { margin-bottom: 16px; color: #222; font-size: 22px; font-weight: 600; }

    .social-buttons { display: flex; gap: 10px; margin-bottom: 14px; }
    .social-btn {
      flex: 1; padding: 8px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px;
      display: flex; align-items: center; justify-content: center; transition: 0.25s; color: #fff; touch-action: manipulation;
    }
    .gmail-btn { background: #e57373; }
    .facebook-btn { background: #4267B2; }
    .social-btn img { height: 18px; width: 18px; margin-right: 6px; }
    .social-btn:hover { opacity: 0.92; transform: translateY(-1px); }

    hr { margin: 10px 0 12px; border: 0; border-top: 1px solid #ddd; }

    input[type="text"], input[type="email"], input[type="password"] {
      width: 100%; padding: 10px; margin: 6px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 14px;
      background: #fff; color: #333;
    }
    input::placeholder { color: #999; }

    .password-wrapper { position: relative; width: 100%; margin: 6px 0; }
    .password-wrapper input { margin: 0; padding-right: 38px; }
    .toggle-password {
      position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
      border: none; background: transparent; cursor: pointer; font-size: 18px; color: #777; padding: 0; line-height: 1;
      display: flex; align-items: center; justify-content: center; user-select: none;
    }
    .toggle-password:hover { color: #333; }

    button.submit-btn {
      width: 100%; padding: 11px; margin-top: 10px; border: none; border-radius: 10px; font-size: 15px; cursor: pointer;
      background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; transition: 0.25s; touch-action: manipulation;
    }
    button.submit-btn:hover { opacity: 0.94; transform: translateY(-1px); }

    .terms-inline {
      margin-top: 8px; font-size: 12px; color: #555; display: flex; flex-direction: column; text-align: left;
    }
    .terms-inline label { display: flex; align-items: center; gap: 6px; cursor: pointer; }
    .terms-inline a { color: #667eea; text-decoration: underline; font-size: 12px; cursor: pointer; }
    .terms-error input[type="checkbox"] { outline: 2px solid red; box-shadow: 0 0 6px red; }

    .error-message {
      color: #d32f2f; font-size: 12px; margin-top: 5px; opacity: 0; transform: translateY(-3px);
      transition: opacity 0.3s ease, transform 0.25s ease; display: none; text-align: left;
    }
    .error-message.show { display: block; opacity: 1; transform: translateY(0); }

    .success-message { color: #2e7d32; font-size: 13px; margin-top: 8px; font-weight: 600; display: none; text-align: left; }

    .sign-in-link { display: block; text-align: center; margin-top: 12px; font-size: 13px; color: #555; text-decoration: none; }
    .sign-in-link span { font-weight: bold; text-decoration: underline; color: #444; }
    .sign-in-link:hover span { color: #000; }

    /* Terms Modal */
    .terms-modal-backdrop {
      position: fixed; inset: 0; background: rgba(0, 0, 0, 0.45); display: none; align-items: center; justify-content: center;
      z-index: 50; padding: 10px;
    }
    .terms-modal {
      background: #ffffff; border-radius: 14px; max-width: 520px; width: 100%; max-height: 85vh; display: flex; flex-direction: column;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35); padding: 18px 18px 14px;
    }
    .terms-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 10px; }
    .terms-modal-title { font-size: 18px; font-weight: 600; color: #1f1f1f; }
    .terms-close-btn { background: transparent; border: none; font-size: 13px; font-weight: 600; cursor: pointer; color: #0067b8; padding: 4px 8px; }
    .terms-close-btn:hover { color: #00539a; text-decoration: underline; }
    .terms-modal-subtitle { font-size: 12px; color: #555; margin-bottom: 8px; }
    .terms-modal-content {
      flex: 1; padding: 8px; margin-bottom: 4px; border-radius: 8px; background: #fafafa; border: 1px solid #ddd;
      overflow-y: auto; font-size: 12px; color: #444;
    }
    .terms-modal-content h3 { font-size: 13px; margin: 8px 0 4px; font-weight: 600; color: #222; }
    .terms-modal-content p { margin-bottom: 6px; line-height: 1.4; }
    .terms-modal-content ul { padding-left: 16px; margin-bottom: 6px; }

    @media (max-width: 480px) {
      body { padding: 10px; }
      .logo { height: 115px; }
      .header-row { top: -10px; }
      .container { padding: 18px 14px 16px; border-radius: 14px; }
      h2 { font-size: 20px; }
      .terms-modal { max-width: 100%; max-height: 90vh; padding: 14px 12px 10px; }
    }
  </style>
</head>
<body>

<div class="overlay">
  <img src="../images/background.png" alt="Background" class="bg-image">
</div>

<div class="header-row">
  <a href="../index.html">
    <img src="../images/remblyxlogo.png" alt="Logo" class="logo">
  </a>
</div>

<div class="container">
  <h2>Create Account</h2>

  <div class="social-buttons">
    <button type="button" class="social-btn gmail-btn">
      <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Gmail Icon">Gmail
    </button>
    <button type="button" class="social-btn facebook-btn">
      <img src="https://img.icons8.com/color/48/000000/facebook-new.png" alt="Facebook Icon">Facebook
    </button>
  </div>

  <hr>

  <p id="error" class="error-message"></p>
  <p id="success" class="success-message"></p>

  <button id="open-email-btn" class="submit-btn" style="display:none;">Open my email</button>

  <form id="signup-form">
  <input type="email" name="email" placeholder="Email" required>

  <!-- Password with press & hold eye -->
  <div class="password-wrapper">
    <input type="password" id="password" name="password" placeholder="Password" required>
    <button type="button" id="toggle-password" class="toggle-password" aria-label="Hold to show password">
      <i id="password-eye-icon" class="fi fi-rr-eye-crossed"></i>
    </button>
  </div>

  <div class="terms-inline" id="terms-wrapper">
    <label>
      <input type="checkbox" id="terms">
      I agree to the <a id="terms-link">Terms &amp; Conditions</a>
    </label>
    <div id="terms-error" class="error-message">⚠ Please check this box to continue.</div>
  </div>

  <button type="submit" class="submit-btn">Sign Up</button>
</form>
  <a href="../pages/login.html" class="sign-in-link">Already have an account? <span>Sign In</span></a>
</div>

<!-- Terms & Conditions Modal -->
<div id="terms-modal-backdrop" class="terms-modal-backdrop">
  <div class="terms-modal">
    <div class="terms-modal-header">
      <div class="terms-modal-title">Remblyx Terms &amp; Conditions</div>
      <button class="terms-close-btn" id="terms-close-btn">Back</button>
    </div>
    <div class="terms-modal-subtitle">Please review these terms before creating your Remblyx account.</div>
    <div class="terms-modal-content">
      <p>By creating a Remblyx account, you agree to our usage policies, data handling practices, and security standards.</p>
      <h3>1. Data usage</h3>
      <p>We securely store account information to provide core functionality. We do not sell your personal data.</p>
      <h3>2. Acceptable use</h3>
      <ul>
        <li>No unauthorized access, reverse engineering, or abuse of the platform.</li>
        <li>No use of Remblyx for harmful, fraudulent, or illegal activities.</li>
      </ul>
      <h3>3. Security</h3>
      <p>You are responsible for keeping your login credentials confidential and notifying us of suspicious activity.</p>
      <h3>4. Updates to terms</h3>
      <p>We may update these terms periodically. Continued use of your account after changes indicates acceptance.</p>
      <p>If you do not agree, do not create or continue using your Remblyx account.</p>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    createUserWithEmailAndPassword,
    sendEmailVerification,
    GoogleAuthProvider,
    FacebookAuthProvider,
    signInWithPopup,
    signOut,
    onAuthStateChanged
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    serverTimestamp,
    getDoc,
    collection,
    getDocs,
    query,
    where,
    deleteField
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAEosHpiAT72yIIvaT1a8-lAXwsw-mR3i8",
    authDomain: "remblyx-medisignal.firebaseapp.com",
    projectId: "remblyx-medisignal",
    storageBucket: "remblyx-medisignal.appspot.com",
    messagingSenderId: "50711670199",
    appId: "1:50711670199:web:0c9c2ff72cd77234ce0c32",
    measurementId: "G-JQ3843RM4V"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Elements
  const form = document.getElementById("signup-form");
  const terms = document.getElementById("terms");
  const termsError = document.getElementById("terms-error");
  const termsWrapper = document.getElementById("terms-wrapper");
  const errorText = document.getElementById("error");
  const successText = document.getElementById("success");
  const openEmailBtn = document.getElementById("open-email-btn");

  const termsLink = document.getElementById("terms-link");
  const termsModalBackdrop = document.getElementById("terms-modal-backdrop");
  const termsCloseBtn = document.getElementById("terms-close-btn");

  const passwordInput = document.getElementById("password");
  const togglePasswordBtn = document.getElementById("toggle-password");
  const passwordEyeIcon = document.getElementById("password-eye-icon");

  const googleBtn = document.querySelector(".gmail-btn");
  const facebookBtn = document.querySelector(".facebook-btn");

  const googleProvider = new GoogleAuthProvider();
  const facebookProvider = new FacebookAuthProvider();
  let popupInProgress = false;

  // === SAME PLAN / MEMBERSHIP HELPERS AS login.html ===

  const DEV_EMAILS = ["medisignal.remblyx@gmail.com"];
  const normalizeEmail = (s) => (s || "").trim().toLowerCase();

  function redirectByPlan(plan){
    if (plan === "Basic")           window.location.href = "./basic_plan.html";
    else if (plan === "Premium")    window.location.href = "./premium_plan.html";
    else if (plan === "Enterprise") window.location.href = "./enterprise_plan.html";
    else if (plan === "Developers") window.location.href = "./developer_plan.html";
    else                            window.location.href = "./basic_plan.html"; // fallback
  }

  async function loadUserPlan(user){
    try {
      const ref  = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? (snap.data() || {}) : {};
      const emailLower = normalizeEmail(user.email);

      // New / missing doc
      if (!data.plan){
        const base = data.basePlan || "Basic";
        await setDoc(ref, {
          email: emailLower,
          plan: base,
          basePlan: base
        }, { merge:true });
        return base;
      }

      // Backfill basePlan / normalised email
      const updates = {};
      if (!data.basePlan) updates.basePlan = data.plan;
      if (data.email !== emailLower) updates.email = emailLower;

      if (Object.keys(updates).length){
        await setDoc(ref, updates, { merge:true });
      }

      return data.plan;
    } catch (e){
      console.warn("loadUserPlan failed, defaulting to Basic", e);
      return "Basic";
    }
  }

  async function ensureDevelopersPlanIfAllowed(user){
    const emailLower = normalizeEmail(user.email);
    const isDev = DEV_EMAILS.includes(emailLower);
    if (!isDev) return null;

    try {
      const ref  = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? (snap.data() || {}) : {};

      if (data.plan === "Developers"){
        if (data.email !== emailLower){
          await setDoc(ref, { email: emailLower }, { merge:true });
        }
        return "Developers";
      }

      await setDoc(ref, {
        email: emailLower,
        plan: "Developers",
        basePlan: "Developers"
      }, { merge:true });

      return "Developers";
    } catch (e){
      console.warn("ensureDevelopersPlanIfAllowed failed", e);
      return null;
    }
  }

  async function maybeApplyInboundMembership(user, currentLoadedPlan){
    try {
      const memberEmail = normalizeEmail(user.email);

      const userRef  = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.exists() ? (userSnap.data() || {}) : {};

      const basePlan =
        userData.basePlan ||
        currentLoadedPlan ||
        userData.plan ||
        "Basic";

      const qLinks = query(
        collection(db, "plan_links"),
        where("memberEmail", "==", memberEmail)
      );
      const snap = await getDocs(qLinks);

      const activeLinks = snap.docs.filter(d => {
        const f = d.data() || {};
        return f.isActive !== false && !!f.plan;
      });

      // No active membership → restore base plan
      if (activeLinks.length === 0) {
        if (
          userData.plan !== basePlan ||
          userData.basePlan !== basePlan ||
          userData.activeLinkId
        ) {
          await setDoc(
            userRef,
            {
              plan: basePlan,
              basePlan: basePlan,
              activeLinkId: deleteField()
            },
            { merge: true }
          );
        }
        return basePlan;
      }

      // Use first membership link
      const first = activeLinks[0];
      const f     = first.data() || {};
      const membershipPlan = f.plan || basePlan;

      await setDoc(
        userRef,
        {
          plan:         membershipPlan,
          basePlan:     basePlan,
          activeLinkId: first.id
        },
        { merge: true }
      );

      return membershipPlan;
    } catch (err) {
      console.warn("inbound membership check failed", err);
      return currentLoadedPlan;
    }
  }

  /** Main entry used on OAuth sign-up / login */
  async function ensurePlanOnLogin(user){
    const forced = await ensureDevelopersPlanIfAllowed(user);
    let plan = forced || await loadUserPlan(user);
    if (!forced){
      plan = await maybeApplyInboundMembership(user, plan);
    }
    return plan;
  }

  // === UI helpers ===

  const showError = (msg) => {
    errorText.textContent = msg;
    errorText.classList.add("show");
  };
  const clearError = () => {
    errorText.textContent = "";
    errorText.classList.remove("show");
  };
  const showSuccess = (msg) => {
    successText.textContent = msg;
    successText.style.display = "block";
  };

  const getEmailProviderUrl = (email) => {
    const domain = (email.split("@")[1] || "").toLowerCase();
    if (domain === "gmail.com") return "https://mail.google.com";
    if (domain === "yahoo.com" || domain === "ymail.com") return "https://mail.yahoo.com";
    if (domain === "outlook.com" || domain === "hotmail.com" || domain === "live.com") return "https://outlook.live.com/mail";
    if (domain === "icloud.com") return "https://www.icloud.com/mail";
    return "https://" + domain;
  };

  // Terms modal
  const openTermsModal = () => { if (termsModalBackdrop) termsModalBackdrop.style.display = "flex"; };
  const closeTermsModal = () => { if (termsModalBackdrop) termsModalBackdrop.style.display = "none"; };
  if (termsLink) termsLink.addEventListener("click", (e) => { e.preventDefault(); openTermsModal(); });
  if (termsCloseBtn) termsCloseBtn.addEventListener("click", closeTermsModal);
  if (termsModalBackdrop) {
    termsModalBackdrop.addEventListener("click", (e) => {
      if (e.target === termsModalBackdrop) closeTermsModal();
    });
  }

  // Hold-to-show password (preserve caret)
  if (togglePasswordBtn && passwordInput && passwordEyeIcon) {
    let lastSelection = { start: null, end: null };
    const rememberSelection = () => {
      try {
        lastSelection.start = passwordInput.selectionStart;
        lastSelection.end = passwordInput.selectionEnd;
      } catch { lastSelection.start = lastSelection.end = null; }
    };
    const restoreSelection = () => {
      if (lastSelection.start !== null && lastSelection.end !== null && document.activeElement === passwordInput) {
        requestAnimationFrame(() => {
          try { passwordInput.setSelectionRange(lastSelection.start, lastSelection.end); } catch {}
        });
      }
    };
    const showPassword = () => {
      rememberSelection();
      passwordInput.type = "text";
      passwordInput.focus();
      restoreSelection();
      passwordEyeIcon.classList.remove("fi-rr-eye-crossed");
      passwordEyeIcon.classList.add("fi-rr-eye");
    };
    const hidePassword = () => {
      rememberSelection();
      passwordInput.type = "password";
      passwordInput.focus();
      restoreSelection();
      passwordEyeIcon.classList.remove("fi-rr-eye");
      passwordEyeIcon.classList.add("fi-rr-eye-crossed");
    };
    ["mousedown", "touchstart"].forEach(evt => {
      togglePasswordBtn.addEventListener(evt, (e) => {
        e.preventDefault();
        showPassword();
      }, { passive: false });
    });
    ["mouseup", "mouseleave", "touchend", "touchcancel"].forEach(evt => {
      window.addEventListener(evt, () => {
        if (passwordInput.type === "text") hidePassword();
      });
    });
  }

  // Clear terms error on change
  if (terms) {
    terms.addEventListener("change", () => {
      if (terms.checked) {
        termsError.classList.remove("show");
        termsWrapper.classList.remove("terms-error");
      }
    });
  }

  // === EMAIL / PASSWORD SIGN-UP (same UX, but email is normalised + basePlan) ===

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    clearError();
    successText.style.display = "none";
    if (openEmailBtn) openEmailBtn.style.display = "none";

    if (!terms.checked) {
      termsError.classList.add("show");
      termsWrapper.classList.add("terms-error");
      return;
    } else {
      termsError.classList.remove("show");
      termsWrapper.classList.remove("terms-error");
    }

    const email = form.email.value.trim();
    const password = form.password.value.trim();

    if (!email || !password) {
      return showError("⚠ Please fill in all fields.");
    }

    const emailLower = normalizeEmail(email);

    try {
      const { user } = await createUserWithEmailAndPassword(auth, emailLower, password);

      // Create/merge the user's doc with default plan + basePlan
      try {
        await setDoc(doc(db, "users", user.uid), {
          email: emailLower,
          plan: "Basic",
          basePlan: "Basic",
          createdAt: serverTimestamp()
        }, { merge: true });
      } catch (e) {
        console.warn("default plan write failed (will be fixed on login):", e);
      }

      // Send verification, then sign out to prevent unverified access
      try {
        await sendEmailVerification(user);
      } catch (err) {
        showError("⚠ Account created, but failed to send verification email.");
      }

      // Show instructions + "Open my email" button
      showSuccess(
        `Account created! We've sent a verification link to ${emailLower}. ` +
        `Check your inbox or spam folder and click the link to activate your account.`
      );

      if (openEmailBtn) {
        const providerUrl = getEmailProviderUrl(emailLower);
        openEmailBtn.onclick = () => window.open(providerUrl, "_blank");
        openEmailBtn.style.display = "inline-block";
      }

      // Log out unverified password users
      try { await signOut(auth); } catch {}

      form.reset();
      terms.checked = false;
    } catch (error) {
      let message = "⚠ Something went wrong. Please try again.";
      if (error.code === "auth/email-already-in-use")      message = "⚠ Email already registered!";
      else if (error.code === "auth/invalid-email")        message = "⚠ Invalid email address.";
      else if (error.code === "auth/weak-password")        message = "⚠ Password should be at least 6 characters.";
      else if (error.code === "auth/unauthorized-domain")  message = "⚠ Unauthorized domain. Add this domain in Firebase.";
      showError(message);
    }
  });

  // === GOOGLE OAUTH (from signup page) ===
  googleBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (popupInProgress) return;
    popupInProgress = true;
    clearError();
    successText.style.display = "none";
    if (openEmailBtn) openEmailBtn.style.display = "none";

    try {
      await signInWithPopup(auth, googleProvider);
      // onAuthStateChanged will handle plan + membership + redirect
    } catch (error) {
      if (error.code !== "auth/cancelled-popup-request") {
        showError("⚠ Google sign-in failed. Check Firebase/Google config.");
      }
    } finally {
      popupInProgress = false;
    }
  });

  // === FACEBOOK OAUTH (from signup page) ===
  facebookBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (popupInProgress) return;
    popupInProgress = true;
    clearError();
    successText.style.display = "none";
    if (openEmailBtn) openEmailBtn.style.display = "none";

    try {
      await signInWithPopup(auth, facebookProvider);
      // onAuthStateChanged will handle plan + membership + redirect
    } catch (error) {
      if (error.code !== "auth/cancelled-popup-request") {
        showError("⚠ Facebook sign-in failed. Check Facebook + Firebase config.");
      }
    } finally {
      popupInProgress = false;
    }
  });

  // If user somehow lands on signup already logged-in (e.g., OAuth return),
  // route them to the correct plan using the same logic as login.html
  onAuthStateChanged(auth, async (user) => {
    if (!user) return;

    const isPasswordUser = user.providerData.some(p => p.providerId === "password");
    if (!isPasswordUser) {
      try {
        const finalPlan = await ensurePlanOnLogin(user);
        redirectByPlan(finalPlan);
      } catch (e) {
        console.error("Signup auth-state plan flow failed:", e);
        redirectByPlan("Basic");
      }
    }
    // Password users must verify via email first – login.html handles them after verification
  });

  if (openEmailBtn) openEmailBtn.style.display = "none";
</script>
</body>
</html>




