<!DOCTYPE html>
<html lang="en" data-page-plan="Enterprise">
<head>
  <meta charset="UTF-8" />
  <title>Remblyx ‚Äì Enterprise Plan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="../images/medisignal.png" />
  <link rel="apple-touch-icon" href="../images/medisignal.png" />
  <style>
    /* ===== Roles chips (Enterprise + Developers) ===== */
    .role-chip{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border:1px solid #e5e7eb; border-radius:999px;
      font-size: var(--text-xs); cursor:pointer; user-select:none; background:#fff;
    }
    .role-chip.active{ background:#eef2ff; border-color:#93c5fd; }
    .role-chip .dot{ width:8px; height:8px; border-radius:999px; background:#9ca3af; }
    .role-chip.active .dot{ background:#3b82f6; }
    .role-row{ display:flex; gap:8px; flex-wrap:wrap; }
    .save-badge{ margin-left:8px; font-size:10px; color:#6b7280 }
    .save-badge.ok{ color:#059669 } .save-badge.err{ color:#b91c1c }

    /* ===== In-app Email Viewer ===== */
    .email-modal{ position:fixed; inset:0; display:none; z-index:2000; }
    .email-modal.show{ display:block; }
    .email-modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .email-modal-content{
      position:absolute; inset:6% 8%;
      background:#fff; border-radius:14px; box-shadow:0 18px 48px rgba(0,0,0,.35);
      display:flex; flex-direction:column; overflow:hidden; border:1px solid #e5e7eb;
    }
    .email-modal-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 14px; border-bottom:1px solid #e5e7eb; background:#f9fafb; }
    .email-modal-subject{ font-size:var(--text-lg); font-weight:600; color:#111827; }
    .email-modal-meta{ font-size:var(--text-xs); color:#6b7280; margin-top:2px; }
    .email-modal-close{ border:1px solid #e5e7eb; background:#fff; border-radius:10px; padding:6px 10px; font-size:16px; cursor:pointer; }
    .email-iframe{ width:100%; height:100%; border:0; flex:1; background:#fff; }
    .email-plain{ margin:0; padding:12px 14px; white-space:pre-wrap; font:13px/1.5 ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; overflow:auto; flex:1; background:#fff; }

    /* Make the "Open" look like a link but it's a button */
    #email-board .open-link{
      background:none; border:none; text-decoration:underline; cursor:pointer; font:inherit; padding:0;
    }

    :root{
      --radius-lg:18px; --radius-md:12px; --radius-sm:8px;
      --space-1:6px; --space-2:8px; --space-3:12px; --space-4:16px;
      --text-xs: clamp(10px, 2.5vw, 12px);
      --text-sm: clamp(11px, 2.6vw, 13px);
      --text-base: clamp(12px, 3vw, 14px);
      --text-lg: clamp(14px, 3.5vw, 18px);
    }

    *{box-sizing:border-box;margin:0;padding:0;font-family:Arial,sans-serif}
    body{ background:#f5f5f5;min-height:100vh;color:#222; display:flex;justify-content:center;align-items:flex-start; position:relative;overflow:hidden;padding:16px; }
    .overlay{position:fixed;inset:0;z-index:-1}
    .bg-image{width:100%;height:100%;object-fit:cover;filter:blur(4px);opacity:.8}

    .header-row{position:fixed;top:8px;left:8px;z-index:40}
    .logo{height:160px;cursor:pointer;transition:.3s ease}
    .logo:hover{filter:brightness(1.1);transform:scale(1.03)}

    .wrapper{width:100%;max-width:1200px;margin-top:58px;display:flex;flex-direction:column;gap:16px;z-index:10}

    #main-dashboard{
      display:none;
      height:calc(100dvh - 110px);
      max-height:calc(100dvh - 110px);
      background:rgba(255,255,255,.96);
      border-radius:var(--radius-lg);
      box-shadow:0 10px 26px rgba(0,0,0,.2);
      grid-template-columns:230px 1fr;
      overflow:hidden;
      display:grid;
    }

    .sidebar{ background:#111827;color:#e5e7eb;display:flex;flex-direction:column; padding:14px 10px 10px;gap:10px;position:relative;z-index:60; }
    .sidebar-title{font-size:var(--text-sm);font-weight:600;margin-bottom:4px;padding:0 4px;color:#9ca3af;text-transform:uppercase;letter-spacing:.06em}
    .nav-item{display:flex;align-items:center;gap:8px;padding:10px;border-radius:8px;font-size:var(--text-base);cursor:pointer;color:#d1d5db;transition:.2s}
    .nav-item:hover{background:rgba(249,250,251,.06)}
    .nav-item.active{background:#111827;border-left:3px solid #667eea;padding-left:10px;color:#fff}
    .icon-dot{width:7px;height:7px;border-radius:999px;background:#4ade80}
    .sidebar-spacer{flex:1}
    .sidebar-plan-label{font-size:var(--text-xs);color:#9ca3af;padding:8px 8px;border-radius:8px;border:1px solid rgba(156,163,175,.4);background:rgba(17,24,39,.96);display:flex;flex-direction:column;gap:4px;cursor:pointer;transition:.2s}
    .sidebar-plan-label:hover{background:rgba(31,41,55,1);border-color:#60a5fa}
    .sidebar-plan-label strong{color:#60a5fa;font-weight:600}
    .logout-link{font-size:var(--text-xs);color:#9ca3af;text-align:left;padding:6px 6px;cursor:pointer;text-decoration:underline}
    .logout-link:hover{color:#fff}

    .main-area{display:flex;flex-direction:column;padding:10px 12px 10px;gap:8px;min-width:0}
    .top-bar{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .top-left{display:flex;align-items:center;gap:8px;min-width:0}
    .board-title{font-size:var(--text-lg);font-weight:600;color:#111827;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .board-subtitle{font-size:var(--text-xs);color:#6b7280}
    .top-actions{display:flex;align-items:center;gap:6px;font-size:var(--text-xs)}
    .search-box{padding:8px 12px;border-radius:999px;border:1px solid #e5e7eb;font-size:var(--text-sm);min-width:200px}

    .board-wrapper{ flex:1;border-radius:12px;background:#f9fafb;padding:8px;overflow:auto;border:1px solid #e5e7eb; -webkit-overflow-scrolling:touch; }

    .board-header-row,.board-row{ display:grid;grid-template-columns:2fr 1.2fr 1fr 1fr 1.2fr; gap:6px;align-items:center;font-size:var(--text-sm);padding:6px;border-radius:8px }
    .board-header-row{ font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.04em;background:#f3f4f6;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:5 }
    .board-row{background:#fff;margin-top:4px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .status-pill{padding:3px 7px;border-radius:999px;font-size:10px;display:inline-block;text-align:center;white-space:nowrap}
    .status-green{background:#bbf7d0;color:#166534}.status-yellow{background:#fef9c3;color:#854d0e}.status-red{background:#fee2e2;color:#991b1b}.status-blue{background:#dbeafe;color:#1d4ed8}
    .status-purple{ background:#ede9fe; color:#5b21b6; } /* Replied */

    .dev-grid-header,.dev-grid-row{ display:grid;grid-template-columns:2fr 1fr;gap:6px;align-items:center;font-size:var(--text-sm);padding:6px;border-radius:8px }
    .dev-grid-header{font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.04em;background:#f3f4f6;border-bottom:1px solid #e5e7eb;position:sticky;top:0;z-index:5}
    .dev-grid-row{background:#ffffff;margin-top:4px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
    .plan-select{width:100%;padding:8px 10px;border-radius:6px;border:1px solid #e5e7eb;background:#fff;font-size:var(--text-sm)}
    .inline-status{margin-left:6px;font-size:10px;color:#6b7280}
    .inline-status.ok{color:#059669}.inline-status.err{color:#b91c1c}

    .mobile-menu-btn{ display:none;border:1px solid #e5e7eb;background:#fff;border-radius:8px; padding:8px 10px;font-size:16px;line-height:1;cursor:pointer; }
    .backdrop{ position:fixed;inset:0;background:rgba(0,0,0,.35); opacity:0;pointer-events:none;transition:opacity .2s ease; z-index:1100; }
    .backdrop.show{opacity:1;pointer-events:auto}

    /* Email board grid */
    #email-board .board-header-row,
    #email-board .board-row{
      grid-template-columns: 2fr 3fr 1fr 1.4fr 0.8fr; /* From | Subject | Status | Received | Open */
    }
    #email-board .board-header-row > div:nth-child(3),
    #email-board .board-row        > div:nth-child(3){ text-align: center; }
    #email-board .board-header-row > div:nth-child(4),
    #email-board .board-row        > div:nth-child(4){ text-align: right; white-space: nowrap; }
    #email-board .board-header-row > div:nth-child(5),
    #email-board .board-row        > div:nth-child(5){ text-align: center; }
    #email-board .board-row > div:nth-child(2){ overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    @media (max-width:1024px){ #main-dashboard{grid-template-columns:200px 1fr} .logo{height:140px} }

    @media (max-width:900px){
      #main-dashboard{grid-template-columns:1fr}
      .mobile-menu-btn{display:inline-block}
      .sidebar{ position:fixed;left:-100%;top:0;bottom:0;width:82vw;max-width:320px; transform:translateX(0);transition:left .25s ease;box-shadow:8px 0 20px rgba(0,0,0,.25); z-index:1200; }
      .sidebar.open{left:0}
      .sidebar-title,.nav-item .label,.sidebar-plan-label .label-text{display:none}
      .search-box{min-width:0;width:100%}
      .top-actions{flex:1;justify-content:flex-end}
      .top-left{flex:1}
      html.drawer-open body{ overflow:hidden; }

      /* Hide header + home button + logo if a drawer or viewer is open (defensive) */
      .drawer-open .header-row,
      .viewer-open .header-row,
      .drawer-open #home-tap,
      .viewer-open #home-tap,
      .drawer-open .logo,
      .viewer-open .logo{
        opacity:0; visibility:hidden; pointer-events:none; transition:opacity .15s ease;
      }
    }

    @media (max-width:640px){
      .header-row{ top:max(0px, env(safe-area-inset-top)); left:max(6px, env(safe-area-inset-left)); }
      .home-tap{ position:absolute; top:6px; left:6px; width:44px; height:44px; border-radius:10px; background:transparent; border:none; cursor:pointer; }
      .home-tap:focus-visible{ outline:2px solid #60a5fa; outline-offset:2px; }
      .logo{ height:72px; pointer-events:none }
      .wrapper{ margin-top:86px }
      .board-title{font-size:clamp(14px,4vw,18px)}
      .board-subtitle{display:none}
      .board-header-row{display:none}
      .board-row{ grid-template-columns:1fr;gap:8px;padding:10px;border-radius:var(--radius-md) }
      .board-row > div{display:flex;justify-content:space-between;gap:8px;align-items:center}
      .board-row > div:nth-child(1)::before{content:"Item";font-weight:600;color:#6b7280;margin-right:8px}
      .board-row > div:nth-child(2)::before{content:"Owner";font-weight:600;color:#6b7280;margin-right:8px}
      .board-row > div:nth-child(3)::before{content:"Status";font-weight:600;color:#6b7280;margin-right:8px}
      .board-row > div:nth-child(4)::before{content:"Due";font-weight:600;color:#6b7280;margin-right:8px}
      .board-row > div:nth-child(5)::before{content:"Priority";font-weight:600;color:#6b7280;margin-right:8px}

      /* === Mobile-only: compact Email board (From | Subject | Status | Open) === */
      #email-board .board-header-row{
        display:grid; /* override global mobile rule */
        grid-template-columns: 1.2fr 2fr 0.9fr 0.7fr;
        gap:6px;
      }
      #email-board .board-header-row > div:nth-child(4){ display:none; } /* hide Received heading */

      #email-board .board-row{
        display:grid; /* override stacked */
        grid-template-columns: 1.2fr 2fr 0.9fr 0.7fr; /* From | Subject | Status | Open */
        align-items:center; gap:6px; padding:8px 10px; border-radius:var(--radius-sm);
      }
      #email-board .board-row > div:nth-child(4){ display:none; } /* hide Received cell */

      #email-board .board-row > div::before{ content:none !important; } /* remove stacked labels */
      #email-board .board-row > div:nth-child(1),
      #email-board .board-row > div:nth-child(2){ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
      #email-board .open-link{ font-size: var(--text-xs); }
    }

    @supports(padding:max(0px)){
      body{padding-left:max(16px, env(safe-area-inset-left));padding-right:max(16px, env(safe-area-inset-right));padding-top:max(16px, env(safe-area-inset-top));padding-bottom:max(16px, env(safe-area-inset-bottom));}
    }
    @media (hover:none) and (pointer:coarse){ .logo:hover{ transform:none } }
  </style>
</head>
<body>
  <div class="overlay"><img src="../images/background.png" class="bg-image" alt=""></div>

  <div class="header-row" id="header-row">
    <button id="home-tap" class="home-tap" aria-label="Go to home" title="Home"></button>
    <img src="../images/remblyxlogo.png" alt="Remblyx" class="logo" id="logo" onclick="window.location.href='../index.html'">
  </div>

  <div class="wrapper">
    <div id="main-dashboard">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-title">Workspace</div>

        <div class="nav-item active" data-nav="board"><span class="icon-dot"></span><span class="label">Main Board</span></div>
        <div class="nav-item" data-nav="alerts"><span class="icon-dot"></span><span class="label">Alerts</span></div>
        <div class="nav-item" data-nav="reports"><span class="icon-dot"></span><span class="label">Reports</span></div>
        <div class="nav-item" data-nav="integrations"><span class="icon-dot"></span><span class="label">Integrations</span></div>

        <!-- Email tab (shown for Developers via JS) -->
        <div class="nav-item" data-nav="email" style="display:none;"><span class="icon-dot"></span><span class="label">Email</span></div>

        <!-- Roles tab (Enterprise + Developers via JS) -->
        <div class="nav-item" data-nav="roles" style="display:none;"><span class="icon-dot"></span><span class="label">Roles</span></div>

        <div class="sidebar-spacer"></div>

        <div id="sidebar-plan" class="sidebar-plan-label" title="Click to change plan">
          <span class="label-text">Current Plan</span>
          <strong id="plan-name">-</strong>
        </div>

        <div id="logout" class="logout-link">Log out</div>
        <div id="delete-account" class="logout-link" style="color:#f87171;">Delete account &amp; data</div>
      </aside>

      <div class="backdrop" id="backdrop"></div>

      <div class="main-area">
        <div class="top-bar">
          <div class="top-left">
            <button id="open-sidebar" class="mobile-menu-btn" aria-label="Open menu">‚ò∞</button>
            <div>
              <div id="board-title" class="board-title">Developer Command Center</div>
              <div id="board-subtitle" class="board-subtitle">Overview of all users, their subscriptions, and status.</div>
            </div>
          </div>
          <div class="top-actions"></div>
        </div>

        <!-- Developers Command Center -->
        <div id="dev-tools" class="board-wrapper" style="display:none;">
          <div class="top-actions" style="margin-bottom:8px;gap:8px;flex-wrap:wrap">
            <input id="user-search" class="search-box" placeholder="Search users (email or plan)..." style="flex:1;min-width:220px" />
          </div>
          <div class="dev-grid-header"><div>Email</div><div>Plan</div></div>
          <div id="dev-users"></div>
        </div>




        <!-- Standard board -->
        <div id="standard-board" class="board-wrapper">
          <div class="board-header-row">
            <div>Item</div><div>Owner</div><div>Status</div><div>Due Date</div><div>Priority</div>
          </div>
          <div class="board-row"><div>Onboarding checks</div><div>You</div><div><span class="status-pill status-green">Done</span></div><div>Today</div><div>Low</div></div>
          <div class="board-row"><div>Vital alerts configuration</div><div>Team Lead</div><div><span class="status-pill status-yellow">In progress</span></div><div>Tomorrow</div><div>Medium</div></div>
          <div class="board-row"><div>Critical event pipeline</div><div>Engineering</div><div><span class="status-pill status-red">Stuck</span></div><div>Overdue</div><div>High</div></div>
          <div class="board-row"><div>Integration testing</div><div>DevOps</div><div><span class="status-pill status-blue">Planned</span></div><div>Next week</div><div>Medium</div></div>
        </div>
        <!-- Email board (Developers) -->
        <div id="email-board" class="board-wrapper" style="display:none;">
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
            <input id="email-search" class="search-box" placeholder="Search email (from / subject / status)..." style="flex:1; min-width:220px" />
            <button id="email-refresh" class="mobile-menu-btn" aria-label="Refresh">‚ü≥</button>
          </div>
          <div class="board-header-row">
            <div>From</div><div>Subject</div><div>Status</div><div>Received</div><div>Open</div>
          </div>
          <div id="email-list"></div>
        </div>

        <!-- Roles board (Enterprise + Developers) -->
        <div id="roles-board" class="board-wrapper" style="display:none;">
          <div class="top-actions" style="margin-bottom:8px;gap:8px;flex-wrap:wrap">
            <input id="roles-search" class="search-box" placeholder="Search users (email)..." style="flex:1;min-width:220px" />
          </div>
          <div class="dev-grid-header"><div>Email</div><div>Roles</div></div>
          <div id="roles-list"></div>
        </div>

        <!-- In-app Email Viewer -->
        <div id="email-modal" class="email-modal" aria-hidden="true">
          <div id="email-modal-backdrop" class="email-modal-backdrop"></div>
          <div class="email-modal-content" role="dialog" aria-modal="true" aria-labelledby="email-modal-subject">
            <div class="email-modal-header">
              <div>
                <div id="email-modal-subject" class="email-modal-subject"></div>
                <div id="email-modal-meta" class="email-modal-meta"></div>
              </div>
              <button id="email-modal-close" class="email-modal-close" aria-label="Close">‚úï</button>
            </div>
            <iframe id="email-iframe" class="email-iframe" sandbox=""></iframe>
            <pre id="email-plain" class="email-plain" style="display:none"></pre>
          </div>
        </div>

      </div>


    </div>
  </div>
<script type="module">
/* ======================
   Firebase imports
   ====================== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signOut, deleteUser,
  reauthenticateWithPopup, reauthenticateWithCredential,
  GoogleAuthProvider, EmailAuthProvider
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, deleteDoc, collection,
  getDocs, query, orderBy, limit, onSnapshot, updateDoc,
  serverTimestamp, addDoc, deleteField, where
} from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

/* ======================
   Firebase init
   ====================== */
const firebaseConfig = {
  apiKey: "AIzaSyAEosHpiAT72yIIvaT1a8-lAXwsw-mR3i8",
  authDomain: "remblyx-medisignal.firebaseapp.com",
  projectId: "remblyx-medisignal",
  storageBucket: "remblyx-medisignal.appspot.com",
  messagingSenderId: "50711670199",
  appId: "1:50711670199:web:0c9c2ff72cd77234ce0c32",
  measurementId: "G-JQ3843RM4V"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

/* ======================
   Config / DOM handles
   ====================== */
const DEV_EMAILS   = ["medisignal.remblyx@gmail.com"];
const LOGIN_URL    = "./login.html";
const SELECTION_URL= "./selection.html";
const PLAN_OPTIONS = ["Basic","Premium","Enterprise","Developers"];

/** üîê Page plan guard:
 *  - In enterprise_plan.html ‚Üí "Enterprise"
 *  - In developer_plan.html ‚Üí "Developers"
 */
const PAGE_PLAN    = "Enterprise"; // CHANGE TO "Developers" in developer_plan.html

const mainDashboard      = document.getElementById("main-dashboard");
const sidebarPlanEl      = document.getElementById("sidebar-plan");
const planNameEl         = document.getElementById("plan-name");
const logoutLink         = document.getElementById("logout");
const deleteAccountLink  = document.getElementById("delete-account");
const boardTitle         = document.getElementById("board-title");
const boardSubtitle      = document.getElementById("board-subtitle");
const firstNavLabelEl    = document.querySelector(".nav-item .label");

const devTools           = document.getElementById("dev-tools");
const devUsersContainer  = document.getElementById("dev-users");
const standardBoard      = document.getElementById("standard-board");
const searchInput        = document.getElementById("user-search");

const emailBoard         = document.getElementById("email-board");
const emailList          = document.getElementById("email-list");
const emailSearch        = document.getElementById("email-search");
const emailRefreshBtn    = document.getElementById("email-refresh");

/* Roles UI present in your HTML */
const rolesBoard         = document.getElementById("roles-board");
const rolesList          = document.getElementById("roles-list");
const rolesSearch        = document.getElementById("roles-search");

/* Members tab/board (created dynamically) */
const sidebarEl          = document.getElementById("sidebar");
const openSidebarBtn     = document.getElementById("open-sidebar");
const backdropEl         = document.getElementById("backdrop");
const root               = document.documentElement;

/* Header/logo for hiding while viewer open */
const headerRow   = document.getElementById('header-row');
const logoEl      = document.getElementById('logo');
const homeTapBtn  = document.getElementById('home-tap');
let savedLogoOnclick = null;

/* Email modal */
const emailModal          = document.getElementById("email-modal");
const emailModalBackdrop  = document.getElementById("email-modal-backdrop");
const emailModalClose     = document.getElementById("email-modal-close");
const emailIframe         = document.getElementById("email-iframe");
const emailPlain          = document.getElementById("email-plain");
const emailModalSubject   = document.getElementById("email-modal-subject");
const emailModalMeta      = document.getElementById("email-modal-meta");
const emailModalHeader    = document.querySelector('.email-modal-header');

let currentUser = null;
let currentPlan = null;

let workspaceOwnerUid = null;

let allUsers = [];     // [{uid,email,plan,roles}]
let rolesUsers = [];   // used by Roles panel
let unsubscribeEmails = null;
let cachedEmails = [];
let currentOpenedEmailId = null;


/* Members feature state/refs */
let membersNavEl = null;
let membersBoard = null;
let membersList = null;
let membersInput = null;
let membersAddBtn = null;
let unsubscribeMembers = null;
let cachedMembers = []; // [{id, memberEmail, plan, isActive, linkedUid, linkedPlan}]

/* ======================
   Small utilities
   ====================== */
function setDashboardVisibility(show){
  if (mainDashboard) mainDashboard.style.display = show ? "grid" : "none";
}
function safeTxt(el, txt){
  if (el) el.textContent = txt;
}
function setNavLabelForPlan(plan){
  if (!firstNavLabelEl) return;
  firstNavLabelEl.textContent = (plan === "Developers") ? "Command Center" : "Main Board";
}
function timeAgo(iso){
  if (!iso) return '-';
  const d = new Date(iso);
  const ms = Date.now() - d.getTime();
  const m = Math.floor(ms/60000);
  if (m < 1) return "now";
  if (m < 60) return `${m}m ago`;
  const h = Math.floor(m/60);
  if (h < 24) return `${h}h ago`;
  const days = Math.floor(h/24);
  return `${days}d ago`;
}
const isEmail = (s)=>/^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$/.test((s||'').trim());
const normalizeEmail = (s)=> (s||'').trim().toLowerCase();
const linkDocId = (ownerUid, memberEmail)=> `${ownerUid}__${encodeURIComponent(normalizeEmail(memberEmail))}`;

/** üîÅ Plan-based redirect helper used by this page guard */
function redirectByPlan(plan){
  if (plan === "Basic")         window.location.href = "./basic_plan.html";
  else if (plan === "Premium")  window.location.href = "./premium_plan.html";
  else if (plan === "Enterprise") window.location.href = "./enterprise_plan.html";
  else if (plan === "Developers") window.location.href = "./developer_plan.html";
  else window.location.href = "./basic_plan.html"; // fallback
}

/* ======================
   Drawer helpers (mobile)
   ====================== */
const openDrawer = () => {
  if (!sidebarEl || !backdropEl) return;
  sidebarEl.classList.add("open");
  backdropEl.classList.add("show");
  root.classList.add("drawer-open");
  if (headerRow) { headerRow.setAttribute('aria-hidden','true'); headerRow.style.pointerEvents = 'none'; }
  if (homeTapBtn){ homeTapBtn.disabled = true; homeTapBtn.style.pointerEvents  = 'none'; }
  if (logoEl){ savedLogoOnclick = logoEl.onclick; logoEl.onclick = null; logoEl.style.pointerEvents = 'none'; }
};
const closeDrawer = () => {
  if (!sidebarEl || !backdropEl) return;
  sidebarEl.classList.remove("open");
  backdropEl.classList.remove("show");
  root.classList.remove("drawer-open");
  if (headerRow) { headerRow.removeAttribute('aria-hidden'); headerRow.style.pointerEvents = ''; }
  if (homeTapBtn){ homeTapBtn.disabled = false; homeTapBtn.style.pointerEvents = ''; }
  if (logoEl){ logoEl.onclick = savedLogoOnclick; logoEl.style.pointerEvents = ''; }
};
openSidebarBtn?.addEventListener("click", openDrawer);
backdropEl?.addEventListener("click", closeDrawer);
window.addEventListener("keydown", (e)=>{ if (e.key === "Escape") closeDrawer(); });
sidebarEl?.addEventListener("click", (e)=>{ if (e.target.closest(".nav-item")) closeDrawer(); });

/* ======================
   Plan gating
   ====================== */
function showDevelopersView(){
  setNavLabelForPlan("Developers");
  const emailNav = sidebarEl?.querySelector('[data-nav="email"]');
  if (emailNav) emailNav.style.display = '';

  const rolesNav = sidebarEl?.querySelector('[data-nav="roles"]');
  if (rolesNav) rolesNav.style.display = '';

  ensureMembersUi(true); // Members for Dev

  devTools.style.display = "block";
  standardBoard.style.display = "none";
  emailBoard.style.display = "none";
  rolesBoard.style.display = "none";
  membersBoard && (membersBoard.style.display = "none");
  stopEmailsListener();
  stopMembersListener();
  renderAllUsers();
}
function showRegularView(){
  setNavLabelForPlan(currentPlan);
  const emailNav = sidebarEl?.querySelector('[data-nav="email"]');
  if (emailNav) emailNav.style.display = 'none';

  // Roles visible only for Enterprise
  const rolesNav = sidebarEl?.querySelector('[data-nav="roles"]');
  if (rolesNav) rolesNav.style.display = (currentPlan === 'Enterprise') ? '' : 'none';

  ensureMembersUi(currentPlan === 'Enterprise'); // Members for Enterprise only

  devTools.style.display = "none";
  standardBoard.style.display = "block";
  emailBoard.style.display = "none";
  rolesBoard.style.display = "none";
  membersBoard && (membersBoard.style.display = "none");
  stopEmailsListener();
  stopMembersListener();
}
function applyPlanUi(plan){
  currentPlan = plan || null;
  safeTxt(planNameEl, currentPlan || "-");
  if (boardTitle && boardSubtitle) {
    switch (plan) {
      case "Basic":
        boardTitle.textContent = "Basic Monitoring Board";
        boardSubtitle.textContent = "Lightweight overview for individual usage.";
        break;
      case "Premium":
        boardTitle.textContent = "Premium Team Workspace";
        boardSubtitle.textContent = "Collaborative overview for teams and advanced alerts.";
        break;
      case "Enterprise":
        boardTitle.textContent = "Enterprise Control Center";
        boardSubtitle.textContent = "Full-scale visibility, integrations, and governance.";
        break;
      case "Developers":
        boardTitle.textContent = "Developer Command Center";
        boardSubtitle.textContent = "Internal tools, diagnostics, and elevated limits.";
        break;
      default:
        boardTitle.textContent = "Remblyx Workspace";
        boardSubtitle.textContent = "Overview of your monitoring items, owners, and status.";
    }
  }
  sidebarPlanEl?.classList.remove("locked");
  if (sidebarPlanEl)
    sidebarPlanEl.title = (plan === "Developers") ? "Edit plan (developer)" : "Change subscription plan";
  deleteAccountLink && (deleteAccountLink.style.display = "block");
  (plan === "Developers") ? showDevelopersView() : showRegularView();
}

async function ensureDevelopersPlanIfAllowed(user){
  const emailLower = (user.email || "").toLowerCase();
  const isDev = DEV_EMAILS.includes(emailLower);
  if (!isDev) return null;

  try {
    const ref = doc(db,"users",user.uid);
    const snap = await getDoc(ref);
    const existingData = snap.exists() ? (snap.data() || {}) : {};
    const existingPlan = existingData.plan || null;

    if (existingPlan === "Developers") {
      const updates = {};
      if (existingData.email !== emailLower) updates.email = emailLower;
      if (!existingData.basePlan) updates.basePlan = "Developers";
      if (!existingData.workspaceOwnerUid) updates.workspaceOwnerUid = user.uid;

      if (Object.keys(updates).length){
        await setDoc(ref, updates, { merge:true });
      }

      workspaceOwnerUid = user.uid;
      return "Developers";
    }

    await setDoc(ref, {
      email: emailLower,
      plan: "Developers",
      basePlan: "Developers",
      workspaceOwnerUid: user.uid
    }, { merge:true });

    workspaceOwnerUid = user.uid;
    return "Developers";
  } catch {
    workspaceOwnerUid = user.uid;
    return null;
  }
}



/** If user is a member of someone‚Äôs plan, apply that plan on sign-in
 *  and remember their base / original plan in /users.
 */
async function maybeApplyInboundMembership(user, currentLoadedPlan){
  try {
    const memberEmail = (user.email || "").toLowerCase();

    // 1) Read the user's own doc
    const userRef  = doc(db, "users", user.uid);
    const userSnap = await getDoc(userRef);
    const userData = userSnap.exists() ? (userSnap.data() || {}) : {};

    const basePlan =
      userData.basePlan ||
      currentLoadedPlan ||
      userData.plan ||
      "Basic";

    // Default: they own their own workspace unless a membership says otherwise
    workspaceOwnerUid = userData.workspaceOwnerUid || user.uid;

    // 2) Read all plan_links where this account is the member
    const qLinks = query(
      collection(db, "plan_links"),
      where("memberEmail", "==", memberEmail)
    );
    const snap = await getDocs(qLinks);

    // Only active links with an owner + plan
    const activeLinks = snap.docs.filter(d => {
      const f = d.data() || {};
      return f.isActive !== false && !!f.plan && !!f.ownerUid;
    });

    // ‚ùå No active membership ‚Üí restore original plan & workspace
    if (activeLinks.length === 0) {
      await setDoc(
        userRef,
        {
          plan: basePlan,
          basePlan: basePlan,
          activeLinkId: deleteField(),
          workspaceOwnerUid: workspaceOwnerUid || user.uid
        },
        { merge: true }
      );
      return basePlan;
    }

    // ‚úÖ Apply the first active membership
    const first = activeLinks[0];
    const f     = first.data() || {};

    const ownerUidFromLink = f.ownerUid || user.uid;
    workspaceOwnerUid = ownerUidFromLink;        // üî¥ THIS makes members share the owner‚Äôs workspace
    const membershipPlan  = f.plan || basePlan;  // plan stored on the link

    await setDoc(
      userRef,
      {
        plan:         membershipPlan,
        basePlan:     basePlan,
        activeLinkId: first.id,
        workspaceOwnerUid
      },
      { merge: true }
    );

    return membershipPlan;
  } catch (err) {
    console.warn("inbound membership check failed", err);
    if (!workspaceOwnerUid && user) workspaceOwnerUid = user.uid;
    return currentLoadedPlan;
  }
}



async function loadUserPlan(user){
  try {
    const ref  = doc(db,"users",user.uid);
    const snap = await getDoc(ref);
    const data = snap.exists() ? (snap.data() || {}) : {};
    const emailLower = (user.email || "").toLowerCase();

    // Brand new / missing doc
    if (!data.plan){
      const base = data.basePlan || "Basic";
      await setDoc(ref, {
        email: emailLower,
        plan: base,
        basePlan: base,
        workspaceOwnerUid: user.uid  // üü¢ owner‚Äôs workspace = self
      }, { merge:true });

      workspaceOwnerUid = user.uid;
      return base;
    }

    // Backfill basePlan/email/workspaceOwnerUid if missing or not normalised
    const updates = {};
    if (!data.basePlan) updates.basePlan = data.plan;
    if (data.email !== emailLower) updates.email = emailLower;
    if (!data.workspaceOwnerUid) updates.workspaceOwnerUid = user.uid;

    if (Object.keys(updates).length){
      await setDoc(ref, updates, { merge:true });
    }

    workspaceOwnerUid = data.workspaceOwnerUid || user.uid;
    return data.plan;
  } catch {
    // Fallback: treat user as owning their own workspace
    workspaceOwnerUid = user.uid;
    return "Basic";
  }
}

/* ======================
   Developer users panel
   ====================== */
function userRow({uid,email,plan}){
  const selectHtml = `<select class="plan-select" data-uid="${uid}">
    ${PLAN_OPTIONS.map(p => `<option value="${p}" ${p===plan?'selected':''}>${p}</option>`).join('')}
  </select>`;
  const planCell = (currentPlan === "Developers")
    ? `${selectHtml} <span class="inline-status" id="status-${uid}"></span>`
    : `<span>${plan || '-'}</span>`;
  return `<div class="dev-grid-row" data-uid="${uid}">
    <div>${email}</div>
    <div>${planCell}</div>
  </div>`;
}
function renderList(filter=""){
  if (!devUsersContainer) return;
  const q = (filter || "").trim().toLowerCase();
  const filtered = !q ? allUsers : allUsers.filter(u => {
    const email = (u.email || "").toLowerCase();
    const plan  = (u.plan  || "").toLowerCase();
    const tokens = q.split(/\s+/);
    return tokens.every(tok => {
      if (/^(plan|p):/.test(tok)) {
        const val = tok.replace(/^(plan|p):/,"");
        const wants = val.split(/[|,]/).map(s=>s.trim()).filter(Boolean);
        if (!wants.length) return true;
        return wants.some(w => plan.includes(w));
      }
      if (/^(email|e):/.test(tok)) {
        const val = tok.replace(/^(email|e):/,"");
        return email.includes(val);
      }
      return email.includes(tok) || plan.includes(tok);
    });
  });
  devUsersContainer.innerHTML = filtered.length
    ? filtered.map(userRow).join("")
    : `<div class="dev-grid-row"><div>No users found</div><div>‚Äî</div></div>`;
}
async function fetchAllUsers(){
  const snap = await getDocs(collection(db,"users"));
  const arr = [];
  snap.forEach(d=>{
    const data = d.data() || {};
    arr.push({
      uid: d.id,
      email: data.email || "(no email)",
      plan:  data.plan  || "-",
      roles: data.roles || {}
    });
  });
  allUsers = [...arr].sort((a,b)=>(a.email||"").localeCompare(b.email||""));
}
async function renderAllUsers(){
  if (!devUsersContainer) return;
  devUsersContainer.innerHTML = `<div class="dev-grid-row"><div>Loading users‚Ä¶</div><div>‚Äî</div></div>`;
  try {
    await fetchAllUsers();
    renderList(searchInput?.value || "");
  } catch {
    devUsersContainer.innerHTML = `<div class="dev-grid-row"><div>Permission denied or error</div><div>‚Äî</div></div>`;
  }
}
async function updatePlanForUser(uid, newPlan){
  const status = document.getElementById(`status-${uid}`);
  if (status){ status.className="inline-status"; status.textContent="Saving‚Ä¶"; }
  try{
    await setDoc(doc(db,"users",uid), { plan:newPlan }, { merge:true });
    if (status){ status.className="inline-status ok"; status.textContent="Saved"; }
    const i = allUsers.findIndex(u=>u.uid===uid);
    if (i>=0) allUsers[i].plan = newPlan;
    if (currentUser && uid === currentUser.uid) applyPlanUi(newPlan);
  }catch(e){
    console.error(e);
    if (status){ status.className="inline-status err"; status.textContent="Error"; }
  }
}
devUsersContainer?.addEventListener('change',(e)=>{
  const sel = e.target.closest('.plan-select');
  if (!sel) return;
  const uid = sel.getAttribute('data-uid');
  const newPlan = sel.value;
  if (currentPlan !== 'Developers'){
    alert('Only Developers can change plans.');
    renderAllUsers();
    return;
  }
  if (!PLAN_OPTIONS.includes(newPlan)){
    alert('Invalid plan value.');
    return;
  }
  updatePlanForUser(uid,newPlan);
});
searchInput?.addEventListener('input', ()=>renderList(searchInput.value));

/* ======================
   Roles (Enterprise + Developers)
   ====================== */
const ROLE_KEYS = ['admin','manager','support'];

/** Is this user the owner of the workspace they‚Äôre in? */
function isWorkspaceOwner(){
  if (!currentUser) return false;
  const ownerUid = workspaceOwnerUid || currentUser.uid;
  return currentUser.uid === ownerUid;
}

/** Who can open the Roles tab and manage roles? */
function canManageRoles(){
  // Only owners of an Enterprise / Developers workspace
  return (currentPlan === 'Developers' || currentPlan === 'Enterprise') && isWorkspaceOwner();
}

/** Who can actually toggle the chips? */
function canEditRoles(){
  // Still only Developers can change the chips
  return currentPlan === 'Developers';
}



function roleChip(role, active){
  const disabled = canEditRoles() ? '' : ' disabled style="opacity:.6;cursor:not-allowed" ';
  const pressed  = active ? 'true' : 'false';
  return `<button class="role-chip ${active?'active':''}" data-role="${role}" aria-pressed="${pressed}" ${disabled}>
    <span class="dot"></span>${role}
  </button>`;
}
function rolesRow({uid,email,roles}){
  const map = roles || {};
  const chips = ROLE_KEYS.map(r => roleChip(r, !!map[r])).join('');
  return `<div class="dev-grid-row" data-uid="${uid||''}">
    <div>${email}</div>
    <div><div class="role-row">${chips}</div><span class="save-badge" id="save-${uid||email}"></span></div>
  </div>`;
}
function renderRoles(filter=""){
  if (!rolesList) return;
  const q = (filter||"").trim().toLowerCase();
  const filtered = !q ? rolesUsers : rolesUsers.filter(u => (u.email||"").toLowerCase().includes(q));
  rolesList.innerHTML = filtered.length
    ? filtered.map(rolesRow).join("")
    : `<div class="dev-grid-row"><div>No users found</div><div>‚Äî</div></div>`;
}
async function saveRoles(uid, newMap){
  const ref = doc(db,"users",uid);
  const updates = {};
  ROLE_KEYS.forEach(r=>{
    updates[`roles.${r}`] = newMap[r] ? true : deleteField();
  });
  await updateDoc(ref, updates);
}

async function fetchLinkedEmailsForOwner(ownerUid){
  if (!ownerUid) return new Set();

  const qLinks = query(
    collection(db,'plan_links'),
    where('ownerUid','==', ownerUid)
  );
  const snap = await getDocs(qLinks);

  const emails = new Set();
  snap.forEach(d=>{
    const f = d.data() || {};
    if (f.isActive !== false && f.memberEmail) {
      emails.add(String(f.memberEmail).toLowerCase());
    }
  });

  // Include the owner's own email if we know it
  if (currentUser && currentUser.email && currentUser.uid === ownerUid){
    emails.add(currentUser.email.toLowerCase());
  }

  return emails;
}


async function rebuildRolesUsersForPlan(){
  if (!currentUser) {
    rolesUsers = [];
    return;
  }

  const ownerUid = workspaceOwnerUid || currentUser.uid;

  // Load all users so we can map emails -> { uid, roles }
  await fetchAllUsers();

  // Get the emails that belong to this owner‚Äôs plan (members + owner)
  const linkedEmails = await fetchLinkedEmailsForOwner(ownerUid);

  const rows = [];

  allUsers.forEach(u=>{
    const emailLower = (u.email || '').toLowerCase();
    if (!emailLower) return;

    // Include:
    // - all plan members (from plan_links)
    // - the workspace owner‚Äôs own user row
    if (linkedEmails.has(emailLower) || u.uid === ownerUid){
      rows.push({
        uid: u.uid,
        email: u.email || '(no email)',
        roles: u.roles || {}
      });
    }
  });

  // Fallback: if somehow owner wasn't in allUsers, still add a row
  if (!rows.some(r => r.uid === ownerUid)){
    rows.push({
      uid: ownerUid,
      email: currentUser.email || '(owner)',
      roles: {}
    });
  }

  rolesUsers = rows.sort((a,b)=>(a.email||'').localeCompare(b.email||''));
}
/* ======================
   Members (Enterprise + Developers)
   ====================== */
function canManageMembers(){
  // Only the workspace owner (Enterprise/Developers) can add/remove members
  return (currentPlan === 'Developers' || currentPlan === 'Enterprise') && isWorkspaceOwner();
}
function ensureMembersUi(show){
  if (!membersNavEl){
    membersNavEl = document.createElement('div');
    membersNavEl.className = 'nav-item';
    membersNavEl.setAttribute('data-nav','members');
    membersNavEl.style.display = 'none';
    membersNavEl.innerHTML = `<span class="icon-dot"></span><span class="label">Members</span>`;
    sidebarEl?.insertBefore(membersNavEl, sidebarEl.querySelector('.sidebar-spacer'));
  }
  if (!membersBoard){
    membersBoard = document.createElement('div');
    membersBoard.id = 'members-board';
    membersBoard.className = 'board-wrapper';
    membersBoard.style.display = 'none';
    membersBoard.innerHTML = `
      <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap">
        <input id="member-email-input" class="search-box" placeholder="Add Gmail (member@example.com)..." style="flex:1; min-width:260px" />
        <button id="member-add-btn" class="mobile-menu-btn" aria-label="Add">Ôºã</button>
      </div>
      <div class="dev-grid-header">
        <div>Email</div><div>Status</div>
      </div>
      <div id="members-list"></div>
    `;
    standardBoard.parentNode.insertBefore(membersBoard, emailBoard.nextSibling);

    membersList  = membersBoard.querySelector('#members-list');
    membersInput = membersBoard.querySelector('#member-email-input');
    membersAddBtn= membersBoard.querySelector('#member-add-btn');

    membersAddBtn?.addEventListener('click', onAddMemberClick);
  }

  // Only show the tab if this user actually owns the workspace
  const shouldShow = show && isWorkspaceOwner();
  membersNavEl.style.display = shouldShow ? '' : 'none';
}

function onAddMemberClick(){
  const raw = membersInput?.value || '';
  const email = normalizeEmail(raw);
  if (!isEmail(email)){
    alert('Please enter a valid email.');
    return;
  }
  addMember(email).catch(e=>{
    console.error('addMember failed', e);
    alert('Could not add member. Check your permissions.');
  });
}
function memberRow(item){
  const status = item.linkedUid ? `Linked${item.linkedPlan ? ' ('+item.linkedPlan+')' : ''}` : 'Pending';
  return `<div class="dev-grid-row" data-id="${item.id}">
    <div>${item.memberEmail}</div>
    <div style="display:flex; align-items:center; gap:8px;">
      <span class="inline-status">${status}</span>
      <button class="mobile-menu-btn member-remove" title="Remove" aria-label="Remove">‚úï</button>
    </div>
  </div>`;
}
function renderMembers(){
  if (!membersList) return;
  membersList.innerHTML = cachedMembers.length
    ? cachedMembers.map(memberRow).join('')
    : `<div class="dev-grid-row"><div>No members yet</div><div>‚Äî</div></div>`;
}
function stopMembersListener(){
  if (unsubscribeMembers){
    unsubscribeMembers();
    unsubscribeMembers = null;
  }
}
function startMembersListener(){
  stopMembersListener();
  if (!currentUser) return;

  const ownerUid = workspaceOwnerUid || currentUser.uid;
  const qLinks = query(collection(db,'plan_links'), where('ownerUid','==', ownerUid));

  unsubscribeMembers = onSnapshot(qLinks, async (snap)=>{
    const rows = [];
    snap.forEach(d=>{
      const f = d.data()||{};
      if (f.isActive !== false){
        rows.push({
          id: d.id,
          memberEmail: f.memberEmail || '',
          plan: f.plan || '',
          isActive: f.isActive !== false
        });
      }
    });

    if (!allUsers.length) await fetchAllUsers();  // works for both Enterprise and Developers

    rows.forEach(r=>{
      const u = allUsers.find(x => (x.email||'').toLowerCase() === r.memberEmail.toLowerCase());
      if (u){ r.linkedUid = u.uid; r.linkedPlan = u.plan; }
    });

    cachedMembers = rows.sort((a,b)=> a.memberEmail.localeCompare(b.memberEmail));
    renderMembers();

    if (rolesBoard && rolesBoard.style.display !== 'none' && currentPlan === 'Enterprise'){
      await rebuildRolesUsersForPlan();
      renderRoles(rolesSearch?.value || "");
    }
  }, (err)=>{
    console.error('members snapshot error', err);
    cachedMembers = [];
    renderMembers();
  });
}


/** Add or reactivate a member.
 *  - CREATE: write all fields (matches plan_links create rule)
 *  - UPDATE: only changes isActive + plan (matches update rule)
 */
async function addMember(memberEmail){
  if (!canManageMembers()){
    alert('Only Enterprise/Developers workspace owners can add members.');
    return;
  }
  const normalized = normalizeEmail(memberEmail);
  const ownerUid = workspaceOwnerUid || currentUser.uid;

  const id  = linkDocId(ownerUid, normalized);
  const ref = doc(db,'plan_links', id);
  const snap = await getDoc(ref);

  if (snap.exists()){
    // Update path: may only change isActive / plan per rules
    await updateDoc(ref, {
      isActive: true,
      plan: currentPlan
    });
  } else {
    // Create path: keys must match rules exactly
    await setDoc(ref, {
      ownerUid:    ownerUid,
      ownerEmail: (currentUser.email||'').toLowerCase(),
      memberEmail: normalized,
      plan:        currentPlan,
      createdAt:   serverTimestamp(),
      isActive:    true
    });
  }

  // If member already has an account AND you're a Developer, push plan now
  if (currentPlan === 'Developers'){
    if (!allUsers.length) await fetchAllUsers();
    const existing = allUsers.find(u => (u.email||'').toLowerCase() === normalized);
    if (existing){
      await setDoc(doc(db,'users', existing.uid), { plan: currentPlan }, { merge:true });
    }
  }

  membersInput && (membersInput.value = '');
}
/** Soft-remove a member: just set isActive=false.
 *  Their plan will revert on NEXT login via maybeApplyInboundMembership().
 */
async function removeMember(id){
  await setDoc(doc(db,'plan_links', id), { isActive:false }, { merge:true });
}
document.addEventListener('click', (e)=>{
  const btn = e.target.closest('.member-remove');
  if (!btn) return;
  const row = btn.closest('.dev-grid-row');
  const id  = row?.getAttribute('data-id');
  if (!id) return;
  if (!confirm('Remove this member from your plan?')) return;
  removeMember(id).catch(err=>{
    console.error('remove member error', err);
    alert('Could not remove member.');
  });
});

/* ======================
   Email board + viewer + reply
   ====================== */
function extractAddress(str){
  if(!str) return '';
  const lt = str.indexOf('<'), gt = str.indexOf('>');
  if (lt !== -1 && gt !== -1 && gt > lt) return str.slice(lt+1, gt).trim();
  return str.trim();
}
function prefixRe(subj){
  return !subj ? 'Re:' : (/^\s*re:/i.test(subj) ? subj : `Re: ${subj}`);
}

let replyUI = {
  built:false, box:null, to:null, subject:null, body:null,
  sendBtn:null, cancelBtn:null, toggleBtn:null
};
function ensureReplyUi(){
  if (replyUI.built) return;
  const toggle = document.createElement('button');
  toggle.id = 'email-reply-toggle';
  toggle.className = 'email-modal-close';
  toggle.type = 'button';
  toggle.textContent = '‚Ü© Reply';
  emailModalHeader?.insertBefore(toggle, emailModalClose);

  const box = document.createElement('div');
  box.id = 'email-reply-box';
  box.style.display = 'none';
  box.style.borderTop = '1px solid #e5e7eb';
  box.style.borderBottom = '1px solid #e5e7eb';
  box.style.background = '#fafafa';
  box.style.padding = '10px 12px';
  box.innerHTML = `
    <div style="display:grid;grid-template-columns:70px 1fr;gap:8px;align-items:center;margin-bottom:8px">
      <label for="reply-to">To</label>
      <input id="reply-to" type="text" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px" />
    </div>
    <div style="display:grid;grid-template-columns:70px 1fr;gap:8px;align-items:center;margin-bottom:8px">
      <label for="reply-subject">Subject</label>
      <input id="reply-subject" type="text" style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px" />
    </div>
    <div style="margin-bottom:8px">
      <textarea id="reply-body" rows="6" placeholder="Write your reply..." style="width:100%;border:1px solid #e5e7eb;border-radius:8px;padding:8px 10px"></textarea>
    </div>
    <div style="display:flex;justify-content:flex-end;gap:8px">
      <button id="reply-cancel" type="button" class="email-modal-close">Cancel</button>
      <button id="reply-send"   type="button" class="email-modal-close" style="background:#111827;color:#fff;border-color:#111827">Send</button>
    </div>`;
  emailIframe?.parentNode?.insertBefore(box, emailIframe);

  replyUI = {
    built:true,
    box,
    to:      box.querySelector('#reply-to'),
    subject: box.querySelector('#reply-subject'),
    body:    box.querySelector('#reply-body'),
    sendBtn: box.querySelector('#reply-send'),
    cancelBtn: box.querySelector('#reply-cancel'),
    toggleBtn: toggle
  };

  toggle.addEventListener('click', ()=>{
    box.style.display = (box.style.display === 'none') ? 'block' : 'none';
  });
  replyUI.cancelBtn.addEventListener('click', ()=>{
    box.style.display = 'none';
  });

  replyUI.sendBtn.addEventListener('click', async ()=>{
    try{
      const to       = (replyUI.to?.value || '').trim();
      const subject  = (replyUI.subject?.value || '').trim();
      const bodyText = (replyUI.body?.value || '').trim();
      if(!to || !subject || !bodyText){
        alert('To, Subject, and Body are required.');
        return;
      }

      replyUI.sendBtn.disabled = true;
      replyUI.sendBtn.textContent = 'Sending‚Ä¶';

      await addDoc(collection(db,'email_outbox'), {
        createdAt:      serverTimestamp(),
        createdByUid:   currentUser?.uid || null,
        createdByEmail: currentUser?.email || null,
        to, subject, bodyText,
        inReplyToEmailId: currentOpenedEmailId || null,
        status: 'pending'
      });

      try {
        await setDoc(doc(db, "emails", currentOpenedEmailId), {
          hasReplied: true,
          lastRepliedAt: serverTimestamp(),
          lastRepliedBy: (currentUser?.email || "unknown"),
          isUnread: false
        }, { merge: true });

        const idx = cachedEmails.findIndex(e => e.id === currentOpenedEmailId);
        if (idx >= 0) {
          cachedEmails[idx].hasReplied = true;
          cachedEmails[idx].isUnread = false;
          cachedEmails[idx].lastRepliedBy = currentUser?.email || "you";
          cachedEmails[idx].lastRepliedAt = new Date().toISOString();
          renderEmails(cachedEmails, emailSearch?.value || "");
        }
      } catch (e) {
        console.warn("Could not mark replied from client ‚Äî backend will mark after send:", e);
      }

      alert('Reply queued to send.');
      box.style.display = 'none';
      if (replyUI.body) replyUI.body.value = '';
    }catch(err){
      console.error('Failed to queue reply:', err);
      alert('Could not queue your reply.');
    } finally {
      replyUI.sendBtn.disabled = false;
      replyUI.sendBtn.textContent = 'Send';
    }
  });
}
function openEmailModal(){
  emailModal.classList.add("show");
  emailModal.setAttribute("aria-hidden","false");
  document.addEventListener("keydown", e => {
    if (e.key==="Escape") closeEmailModal();
  }, { once:true });
  document.documentElement.classList.add('viewer-open');
  if (headerRow) headerRow.hidden = true;
}
function closeEmailModal(){
  emailModal.classList.remove("show");
  emailModal.setAttribute("aria-hidden","true");
  emailIframe.srcdoc = "";
  emailPlain.textContent = "";
  emailPlain.style.display = "none";
  emailIframe.style.display = "block";
  document.documentElement.classList.remove('viewer-open');
  if (headerRow) headerRow.hidden = false;
}
emailModalBackdrop?.addEventListener("click", closeEmailModal);
emailModalClose?.addEventListener("click", closeEmailModal);

function renderEmails(list, filter=""){
  const q = (filter || "").toLowerCase().trim();

  const matches = (e, query) => {
    if (!query) return true;
    const from = (e.from||"").toLowerCase();
    const subject = (e.subject||"").toLowerCase();
    const statusText = e.hasReplied ? "replied" : (e.isUnread ? "unread" : "read");
    const tokens = query.split(/\s+/).filter(Boolean);
    return tokens.every(tok => {
      if (tok.startsWith("from:"))    return from.includes(tok.slice(5));
      if (tok.startsWith("subject:")) return subject.includes(tok.slice(8));
      if (["replied","is:replied","status:replied"].includes(tok)) return statusText === "replied";
      if (["unread","is:unread","status:unread"].includes(tok))    return statusText === "unread";
      if (["read","is:read","status:read"].includes(tok))          return statusText === "read";
      return from.includes(tok) || subject.includes(tok) || statusText.includes(tok);
    });
  };

  const filtered = q ? list.filter(e => matches(e,q)) : list;

  emailList.innerHTML = filtered.length
    ? filtered.map(e=>{
        let pillClass, label;
        if (e.hasReplied)     { pillClass = "status-purple"; label = "Replied"; }
        else if (e.isUnread)  { pillClass = "status-blue";   label = "Unread";  }
        else                  { pillClass = "status-green";  label = "Read";    }

        return `<div class="board-row" data-id="${e.id}">
          <div>${e.from || '-'}</div>
          <div>${e.subject || '(no subject)'}</div>
          <div><span class="status-pill ${pillClass}">${label}</span></div>
          <div>${e.receivedAt ? timeAgo(e.receivedAt) : '-'}</div>
          <div><button class="open-link" data-id="${e.id}">Open</button></div>
        </div>`;
      }).join("")
    : `<div class="board-row"><div>No emails found</div><div>‚Äî</div><div>‚Äî</div><div>‚Äî</div><div>‚Äî</div></div>`;
}
function startEmailsListener(){
  const qEmails = query(collection(db,"emails"), orderBy("receivedAt","desc"), limit(200));
  unsubscribeEmails = onSnapshot(qEmails, (snap)=>{
    const rows = [];
    snap.forEach(docu=>{
      const d  = docu.data() || {};
      const ts = d.receivedAt?.toDate ? d.receivedAt.toDate().toISOString() : (d.receivedAt || "");
      rows.push({
        id: docu.id,
        from: d.from || "",
        subject: d.subject || "",
        receivedAt: ts,
        gmailLink: d.gmailLink || "",
        isUnread: d.isUnread === true,
        bodyHtml: d.bodyHtml || d.html || "",
        bodyText: d.bodyText || d.body || d.snippet || "",
        hasReplied: d.hasReplied === true,
        lastRepliedAt: d.lastRepliedAt?.toDate ? d.lastRepliedAt.toDate().toISOString() : (d.lastRepliedAt || ""),
        lastRepliedBy: d.lastRepliedBy || ""
      });
    });
    cachedEmails = rows;
    renderEmails(cachedEmails, emailSearch?.value || "");
  }, (err)=>{
    console.error("emails onSnapshot error:", err);
    emailList.innerHTML = `<div class="board-row"><div>Error loading emails</div><div>‚Äî</div><div>‚Äî</div><div>‚Äî</div></div>`;
  });
}
function stopEmailsListener(){
  if (unsubscribeEmails){
    unsubscribeEmails();
    unsubscribeEmails = null;
  }
}
emailSearch?.addEventListener("input", ()=>renderEmails(cachedEmails, emailSearch.value));
emailRefreshBtn?.addEventListener("click", ()=>renderEmails(cachedEmails, emailSearch?.value || ""));
emailList?.addEventListener("click", async (ev)=>{
  const btn = ev.target.closest(".open-link");
  if (!btn) return;
  const id = btn.getAttribute("data-id");
  const item = cachedEmails.find(x => x.id === id);
  if (!item) return;

  currentOpenedEmailId = id;

  emailModalSubject.textContent = item.subject || "(no subject)";
  const when = item.receivedAt ? new Date(item.receivedAt) : null;
  emailModalMeta.textContent = `${item.from || "Unknown sender"}${when ? ` ‚Ä¢ ${when.toLocaleString()}` : ""}`;

  ensureReplyUi();
  const toAddr = extractAddress(item.from||'');
  const subj   = item.subject||'';
  replyUI.to && (replyUI.to.value = toAddr);
  replyUI.subject && (replyUI.subject.value = prefixRe(subj));
  replyUI.body && (replyUI.body.value = '');
  replyUI.box && (replyUI.box.style.display = 'none');

  if (item.bodyHtml && item.bodyHtml.trim()){
    emailIframe.srcdoc = `<!doctype html><html><head><meta charset="utf-8"><base target="_blank">
      <style>body{font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:#111827;padding:16px}
      img{max-width:100%;height:auto}a{word-break:break-word}
      blockquote{border-left:3px solid #e5e7eb;padding-left:10px;margin-left:0;color:#374151}
      pre,code{white-space:pre-wrap}</style></head><body>${item.bodyHtml}</body></html>`;
    emailIframe.style.display = "block";
    emailPlain.style.display = "none";
  } else if (item.bodyText && item.bodyText.trim()){
    emailPlain.textContent = item.bodyText;
    emailPlain.style.display = "block";
    emailIframe.style.display = "none";
  } else {
    emailPlain.textContent = "This email's body isn't stored. Ask the admin to save `bodyHtml` or `bodyText` in Firestore for full in-app viewing.";
    emailPlain.style.display = "block";
    emailIframe.style.display = "none";
  }

  if (item.isUnread){
    try {
      await updateDoc(doc(db,"emails",id), {
        isUnread: false,
        lastOpenedAt: serverTimestamp(),
        lastOpenedBy: currentUser?.email || null
      });
      item.isUnread = false;
      renderEmails(cachedEmails, emailSearch?.value || "");
    } catch (e){
      console.warn("Couldn't mark as read:", e);
    }
  }
  openEmailModal();
});

/* ======================
   Sidebar navigation
   ====================== */
sidebarEl?.addEventListener("click", async (e)=>{
  const nav = e.target.closest(".nav-item");
  if (!nav) return;

  [...sidebarEl.querySelectorAll('.nav-item')].forEach(n => n.classList.remove('active'));
  nav.classList.add('active');

  const dest = nav.getAttribute('data-nav');

  devTools.style.display      = "none";
  standardBoard.style.display = "none";
  emailBoard.style.display    = "none";
  rolesBoard && (rolesBoard.style.display = "none");
  membersBoard && (membersBoard.style.display = "none");
  stopEmailsListener();
  stopMembersListener();

  if (dest === 'roles'){
    if (!canManageRoles()){
      alert("Only Enterprise/Developers can access Roles.");
      standardBoard.style.display = "block";
      return;
    }
    rolesBoard.style.display = "block";
    await rebuildRolesUsersForPlan();
    renderRoles(rolesSearch?.value || "");
    return;
  }

  if (dest === 'members'){
    if (!canManageMembers()){
      alert("Only Enterprise/Developers can access Members.");
      standardBoard.style.display = "block";
      return;
    }
    membersBoard.style.display = "block";
    startMembersListener();
    return;
  }

  if (dest === 'email'){
    emailBoard.style.display = "block";
    startEmailsListener();
    return;
  }

  if (dest === 'board'){
    if (currentPlan === "Developers"){
      devTools.style.display = "block";
      renderAllUsers();
    } else {
      standardBoard.style.display = "block";
    }
    return;
  }

  standardBoard.style.display = "block";
});

/* ======================
   Auth flow (page-guarded by PAGE_PLAN)
   ====================== */
onAuthStateChanged(auth, async (user)=>{
  if (!user){
    window.location.href = LOGIN_URL;
    return;
  }

  const isPasswordUser = user.providerData.some(p => p.providerId === "password");
  if (isPasswordUser && !user.emailVerified){
    try { await signOut(auth); } catch {}
    window.location.href = LOGIN_URL;
    return;
  }

  currentUser = user;
  setDashboardVisibility(true);

  try {
    const forced = await ensureDevelopersPlanIfAllowed(user);
    let plan   = forced || await loadUserPlan(user);
    if (!forced){
      plan = await maybeApplyInboundMembership(user, plan);
    }

    if (plan !== PAGE_PLAN){
      redirectByPlan(plan);
      return;
    }

    applyPlanUi(plan);
  } catch (e){
    console.error("Dashboard init error:", e);
    redirectByPlan("Basic");
  }
});

/* ======================
   Logout / delete account / plan chip
   ====================== */
logoutLink?.addEventListener("click", async ()=>{
  try { await signOut(auth); window.location.href = LOGIN_URL; }
  catch (error) { console.error("Error during logout: ", error); }
});

/* ---- Re-auth helpers + account deletion ---- */
async function reauthenticateCurrentUser() {
  const u = auth.currentUser;
  if (!u) throw new Error("No authenticated user.");

  const providerId = u.providerData?.[0]?.providerId || "password";

  if (providerId === "google.com") {
    const provider = new GoogleAuthProvider();
    await reauthenticateWithPopup(u, provider);
    return;
  }

  const email = u.email || "";
  const pw = prompt(`For security, please confirm the password for ${email} to delete your account:`);
  if (!pw) throw new Error("Password confirmation was cancelled.");
  const cred = EmailAuthProvider.credential(email, pw);
  await reauthenticateWithCredential(u, cred);
}

async function cleanupUserOwnedData() {
  try {
    await deleteDoc(doc(db,"users", currentUser.uid));
  } catch (e) {
    console.warn("Couldn't delete user doc; continuing:", e);
  }

  try {
    const qLinks = query(collection(db,'plan_links'), where('ownerUid','==', currentUser.uid));
    const snap = await getDocs(qLinks);
    const ops = [];
    snap.forEach(d => {
      // Only change isActive, to match rules
      ops.push(setDoc(doc(db,'plan_links', d.id), { isActive:false }, { merge:true }));
    });
    await Promise.all(ops);
  } catch (e) {
    console.warn("Couldn't soft-delete plan_links; continuing:", e);
  }
}

async function performDeleteAccount() {
  await cleanupUserOwnedData();
  await deleteUser(auth.currentUser);
}

deleteAccountLink?.addEventListener("click", async ()=>{
  if (!confirm("Are you sure you want to delete your account and data? This action cannot be undone.")) return;

  const prevText = deleteAccountLink.textContent;
  deleteAccountLink.style.pointerEvents = "none";
  deleteAccountLink.textContent = "Deleting‚Ä¶";

  try {
    await performDeleteAccount();
    alert("Your account and data have been deleted.");
    window.location.href = LOGIN_URL;
  } catch (err) {
    if (err?.code === "auth/requires-recent-login") {
      try {
        await reauthenticateCurrentUser();
        await performDeleteAccount();
        alert("Your account and data have been deleted.");
        window.location.href = LOGIN_URL;
        return;
      } catch (err2) {
        console.error("Delete after reauth failed:", err2);
        alert("We couldn't delete your account even after re-authenticating. Please try again.");
      }
    } else {
      console.error("Delete account failed:", err);
      alert("We couldn't delete your account. Please try again.");
    }
  } finally {
    deleteAccountLink.style.pointerEvents = "";
    deleteAccountLink.textContent = prevText || "Delete account & data";
  }
});

sidebarPlanEl?.addEventListener("click", async ()=>{
  if (currentPlan === "Developers"){
    const newPlan = prompt("Enter new plan (e.g., Basic, Premium, Enterprise):");
    if (!newPlan) return;
    try {
      await setDoc(doc(db,"users", currentUser.uid), { plan:newPlan }, { merge:true });
      alert("Your plan has been updated to " + newPlan);
      applyPlanUi(newPlan);
    } catch (error){
      console.error("Error updating plan:", error);
    }
  } else {
    try { sessionStorage.setItem("rbx_last_nav", "from_dashboard"); } catch {}
    window.location.replace(SELECTION_URL);
  }
});

/* Phones: tiny fixed home button */
if (window.matchMedia('(max-width: 640px)').matches){
  document.getElementById('home-tap')?.addEventListener('click', ()=>{
    window.location.href = '../index.html';
  });
}
</script>
</body>
</html>
