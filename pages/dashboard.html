<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Remblyx Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="../images/medisignal.png" />
  <link rel="apple-touch-icon" href="../images/medisignal.png" />
  <style>
    /* Your existing CSS for dashboard layout and sidebar */
  </style>
</head>
<body>
  <div class="overlay"><img src="../images/background.png" class="bg-image" alt=""></div>

  <div class="header-row">
    <img src="../images/remblyxlogo.png" alt="Remblyx" class="logo" onclick="window.location.href='../index.html'">
  </div>

  <div class="wrapper">
    <div id="main-dashboard">
      <aside class="sidebar">
        <div class="sidebar-title">Workspace</div>

        <div class="nav-item active"><span class="icon-dot"></span><span class="label">Main Board</span></div>
        <div class="nav-item"><span class="icon-dot"></span><span class="label">Alerts</span></div>
        <div class="nav-item"><span class="icon-dot"></span><span class="label">Reports</span></div>
        <div class="nav-item"><span class="icon-dot"></span><span class="label">Integrations</span></div>

        <div class="sidebar-spacer"></div>

        <!-- Sidebar Plan Label (Click to Change Plan) -->
        <div id="sidebar-plan" class="sidebar-plan-label" title="Click to change plan">
          <span class="label-text">Current Plan</span>
          <strong id="plan-name">-</strong>
        </div>

        <div id="logout" class="logout-link">Log out</div>
        <div id="delete-account" class="logout-link" style="color:#f87171;">Delete account &amp; data</div>
      </aside>
      <div class="main-area">
        <div class="top-bar">
          <div>
            <div id="board-title" class="board-title">Developer Command Center</div>
            <div id="board-subtitle" class="board-subtitle">Overview of all users, their subscriptions, and status.</div>
          </div>
          <div class="top-actions">
            <input id="user-search" class="search-box" placeholder="Search users..." />
          </div>
        </div>

        <!-- Developers Command Center (Only visible to Developers) -->
        <div id="dev-tools" class="board-wrapper" style="display:none;">
          <div class="dev-grid-header">
            <div>Email</div>
            <div>Plan</div>
          </div>
          <div id="dev-users"></div>
        </div>

        <!-- Standard board (hidden for Developers plan) -->
        <div id="standard-board" class="board-wrapper">
          <div class="board-header-row">
            <div>Item</div><div>Owner</div><div>Status</div><div>Due Date</div><div>Priority</div>
          </div>
          <div class="board-row"><div>Onboarding checks</div><div>You</div><div><span class="status-pill status-green">Done</span></div><div>Today</div><div>Low</div></div>
          <div class="board-row"><div>Vital alerts configuration</div><div>Team Lead</div><div><span class="status-pill status-yellow">In progress</span></div><div>Tomorrow</div><div>Medium</div></div>
          <div class="board-row"><div>Critical event pipeline</div><div>Engineering</div><div><span class="status-pill status-red">Stuck</span></div><div>Overdue</div><div>High</div></div>
          <div class="board-row"><div>Integration testing</div><div>DevOps</div><div><span class="status-pill status-blue">Planned</span></div><div>Next week</div><div>Medium</div></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEosHpiAT72yIIvaT1a8-lAXwsw-mR3i8",
      authDomain: "remblyx-medisignal.firebaseapp.com",
      projectId: "remblyx-medisignal",
      storageBucket: "remblyx-medisignal.appspot.com",
      messagingSenderId: "50711670199",
      appId: "1:50711670199:web:0c9c2ff72cd77234ce0c32",
      measurementId: "G-JQ3843RM4V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Config / DOM
    const DEV_EMAILS = ["medisignal.remblyx@gmail.com"];
    const LOGIN_URL = "./login.html";
    const SELECTION_URL = "./selection.html";

    const mainDashboard = document.getElementById("main-dashboard");
    const sidebarPlanEl = document.getElementById("sidebar-plan");
    const planNameEl = document.getElementById("plan-name");
    const logoutLink = document.getElementById("logout");
    const deleteAccountLink = document.getElementById("delete-account");
    const devTools = document.getElementById("dev-tools");
    const devUsersContainer = document.getElementById("dev-users");
    const standardBoard = document.getElementById("standard-board");

    let currentUser = null;
    let currentPlan = null;

    // Show dashboard
    function setDashboardVisibility(show) {
      if (mainDashboard) mainDashboard.style.display = show ? "grid" : "none";
    }

    function safeTxt(el, txt) {
      if (el) el.textContent = txt;
    }

    async function renderAllUsers() {
      if (!devUsersContainer) return;
      devUsersContainer.innerHTML = `<div class="dev-grid-row"><div>Loading users…</div><div>—</div></div>`;
      try {
        const snap = await getDocs(collection(db, "users"));
        let rows = "";
        snap.forEach(d => {
          const data = d.data() || {};
          const email = data.email || "(no email)";
          const plan = data.plan || "-";
          rows += `<div class="dev-grid-row"><div>${email}</div><div>${plan}</div></div>`;
        });
        devUsersContainer.innerHTML = rows || `<div class="dev-grid-row"><div>No users found</div><div>—</div></div>`;
      } catch (e) {
        console.error("Error fetching users:", e);
        devUsersContainer.innerHTML = `<div class="dev-grid-row"><div>Permission denied or error</div><div>—</div></div>`;
      }
    }

    async function applyPlanUi(plan) {
      currentPlan = plan || null;
      safeTxt(planNameEl, currentPlan || "-");

      if (plan === "Developers") {
        devTools.style.display = "block";
        standardBoard.style.display = "none";
        renderAllUsers(); // Show all users if it's a developer
      } else {
        devTools.style.display = "none";
        standardBoard.style.display = "block";
      }

      if (plan === "Developers") {
        sidebarPlanEl.classList.add("locked");
        sidebarPlanEl.title = "Developer accounts cannot change plan";
        sidebarPlanEl.removeEventListener("click", handlePlanChange);
      } else {
        sidebarPlanEl.classList.remove("locked");
        sidebarPlanEl.title = "Click to change plan";
        sidebarPlanEl.addEventListener("click", handlePlanChange);
      }
    }

    // Plan change
    async function handlePlanChange() {
      if (currentPlan !== "Developers") {
        window.location.href = SELECTION_URL;
      }
    }

    // DELETE ACCOUNT & DATA
    deleteAccountLink.addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete your account and data? This action cannot be undone.")) {
        try {
          const userRef = doc(db, "users", currentUser.uid);
          await deleteDoc(userRef);  // Delete user data from Firestore
          await deleteUser(auth.currentUser); // Delete the Firebase Auth user
          alert("Your account and data have been deleted.");
          window.location.href = LOGIN_URL; // Redirect to login page
        } catch (error) {
          console.error("Error deleting account:", error);
        }
      }
    });

    // Fetch user details
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = LOGIN_URL;
        return;
      }
      currentUser = user;

      setDashboardVisibility(true);

      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        let plan = snap.exists() ? snap.data().plan : "Basic"; // Default to Basic if no plan
        applyPlanUi(plan);
      } catch (e) {
        console.error("Dashboard init error:", e);
        applyPlanUi(null);
      }
    });

    // LOGOUT
    logoutLink.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = LOGIN_URL;
      } catch (error) {
        console.error("Error during logout: ", error);
      }
    });
  </script>
</body>
</html>
