<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Remblyx Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="../images/medisignal.png" />
  <link rel="apple-touch-icon" href="../images/medisignal.png" />
  <style>
    /* Your existing styles go here */
  </style>
</head>
<body>
  <div class="overlay"><img src="../images/background.png" class="bg-image" alt=""></div>

  <div class="wrapper">
    <div id="main-dashboard">
      <aside class="sidebar">
        <div class="sidebar-title">Workspace</div>
        <div class="nav-item active"><span class="icon-dot"></span><span class="label">Main Board</span></div>
        <div class="nav-item"><span class="icon-dot"></span><span class="label">Alerts</span></div>
        <div class="nav-item"><span class="icon-dot"></span><span class="label">Reports</span></div>
        <div class="nav-item"><span class="icon-dot"></span><span class="label">Integrations</span></div>

        <div class="sidebar-spacer"></div>

        <div id="sidebar-plan" class="sidebar-plan-label" title="Click to change plan">
          <span class="label-text">Current Plan</span>
          <strong id="plan-name">-</strong>
        </div>

        <div id="logout" class="logout-link">Log out</div>
        <div id="delete-account" class="logout-link" style="color:#f87171;">Delete account &amp; data</div>
      </aside>
      <div class="main-area">
        <div class="top-bar">
          <div>
            <div id="board-title" class="board-title">Developer Command Center</div>
            <div id="board-subtitle" class="board-subtitle">Overview of all users, their subscriptions, and status.</div>
          </div>
          <div class="top-actions">
            <input id="user-search" class="search-box" placeholder="Search users..." />
          </div>
        </div>

        <!-- Developers Command Center -->
        <div id="dev-tools" class="board-wrapper" style="display:none;">
          <div class="dev-grid-header">
            <div>Email</div>
            <div>Plan</div>
          </div>
          <div id="dev-users"></div>
        </div>

        <!-- Standard board -->
        <div id="standard-board" class="board-wrapper">
          <div class="board-header-row">
            <div>Item</div><div>Owner</div><div>Status</div><div>Due Date</div><div>Priority</div>
          </div>
          <div class="board-row"><div>Onboarding checks</div><div>You</div><div><span class="status-pill status-green">Done</span></div><div>Today</div><div>Low</div></div>
          <div class="board-row"><div>Vital alerts configuration</div><div>Team Lead</div><div><span class="status-pill status-yellow">In progress</span></div><div>Tomorrow</div><div>Medium</div></div>
          <div class="board-row"><div>Critical event pipeline</div><div>Engineering</div><div><span class="status-pill status-red">Stuck</span></div><div>Overdue</div><div>High</div></div>
          <div class="board-row"><div>Integration testing</div><div>DevOps</div><div><span class="status-pill status-blue">Planned</span></div><div>Next week</div><div>Medium</div></div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAEosHpiAT72yIIvaT1a8-lAXwsw-mR3i8",
      authDomain: "remblyx-medisignal.firebaseapp.com",
      projectId: "remblyx-medisignal",
      storageBucket: "remblyx-medisignal.appspot.com",
      messagingSenderId: "50711670199",
      appId: "1:50711670199:web:0c9c2ff72cd77234ce0c32",
      measurementId: "G-JQ3843RM4V"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const DEV_EMAILS = ["medisignal.remblyx@gmail.com"];
    let currentUser = null;
    let currentPlan = null;

    const sidebarPlanEl = document.getElementById("sidebar-plan");
    const planNameEl = document.getElementById("plan-name");
    const logoutLink = document.getElementById("logout");
    const deleteAccountLink = document.getElementById("delete-account");
    const mainDashboard = document.getElementById("main-dashboard");

    function setDashboardVisibility(show) {
      if (mainDashboard) {
        mainDashboard.style.display = show ? "grid" : "none";
      }
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "./login.html";
        return;
      }

      currentUser = user;
      const userRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userRef);
      currentPlan = userDoc.exists() ? userDoc.data().plan : null;

      // Show dashboard immediately
      setDashboardVisibility(true);  // Ensures the dashboard is shown immediately

      // Apply plan changes
      if (currentPlan === "Developers") {
        sidebarPlanEl.classList.add("locked");
        sidebarPlanEl.setAttribute("title", "Plan change is disabled for Developers");
      } else {
        sidebarPlanEl.classList.remove("locked");
      }

      // For developers, redirect to selection if they try to upgrade
      if (DEV_EMAILS.includes(user.email.toLowerCase())) {
        window.location.href = "./selection.html";
        return;
      }

      // Render users if developer
      if (currentPlan === "Developers") {
        renderAllUsers();
      }
    });

    // Display all users for Developers
    async function renderAllUsers() {
      const devUsersContainer = document.getElementById("dev-users");
      devUsersContainer.innerHTML = `<div class="dev-grid-row"><div>Loading users…</div><div>—</div></div>`;
      try {
        const snap = await getDocs(collection(db, "users"));
        let rows = "";
        snap.forEach(d => {
          const data = d.data() || {};
          const email = data.email || "(no email)";
          const plan = data.plan || "-";
          rows += `<div class="dev-grid-row"><div>${email}</div><div>${plan}</div></div>`;
        });
        devUsersContainer.innerHTML = rows || `<div class="dev-grid-row"><div>No users found</div><div>—</div></div>`;
      } catch (e) {
        console.error("renderAllUsers error:", e);
        devUsersContainer.innerHTML = `<div class="dev-grid-row"><div>Permission denied or error</div><div>—</div></div>`;
      }
    }

    // Logout functionality
    logoutLink.addEventListener("click", async () => {
      try {
        await signOut(auth);
        window.location.href = "./login.html";
      } catch (error) {
        console.error("Error during logout: ", error);
      }
    });

    // Delete account functionality
    deleteAccountLink.addEventListener("click", async () => {
      if (confirm("Are you sure you want to delete your account and data? This action cannot be undone.")) {
        try {
          await deleteDoc(doc(db, "users", currentUser.uid));  // Delete from Firestore
          await deleteUser(auth.currentUser);  // Delete from Firebase Auth
          alert("Your account and data have been deleted.");
          window.location.href = "./login.html";  // Redirect after deletion
        } catch (error) {
          console.error("Error deleting account:", error);
        }
      }
    });
  </script>
</body>
</html>
