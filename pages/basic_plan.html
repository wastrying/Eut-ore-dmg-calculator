<!-- ====================== Dependant Modal ====================== -->
<div id="dependantModal" class="modal">
  <div class="modal-content">
    <h2>Add Dependant</h2>
    <p class="error" id="modalError"></p>
    <form id="dependantForm">
      <label for="depName">Name:</label>
      <input type="text" id="depName" required />

      <label for="depMedicine">Type of Medicine:</label>
      <input type="text" id="depMedicine" required />

      <label>Dosage:</label>
      <div class="dosage-row">
        <input type="number" id="depDosageNumber" min="0" placeholder="Amount" required />
        <select id="depDosageUnit">
          <option value="">Unit</option>
          <option value="mg">mg</option>
          <option value="g">g</option>
        </select>
      </div>

      <label>Times/Doses:</label>
      <div id="timePickers">
        <input type="time" class="dose-time" required />
      </div>
      <button type="button" id="addTimeBtn" style="background:#3b82f6;margin-bottom:10px;">Add Another Time</button>

      <label for="depNotes">Notes:</label>
      <input type="text" id="depNotes" placeholder="Optional notes" />

      <button type="submit">Save Dependant</button>
      <button type="button" id="closeModalBtn" style="background:#f87171;margin-top:4px;">Cancel</button>
    </form>
  </div>
</div>

<script>
  // ===== Modal & Dependant Logic =====
  let dependantAdded = false;

  const addBtn = document.getElementById('addDependantBtn');
  const modal = document.getElementById('dependantModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const form = document.getElementById('dependantForm');
  const errorMsg = document.getElementById('modalError');

  const infoBox = document.getElementById('dependantInfo');
  const dispName = document.getElementById('dispName');
  const dispMedicine = document.getElementById('dispMedicine');
  const dispTimes = document.getElementById('dispTimes');
  const dispDosage = document.getElementById('dispDosage');
  const dispNotes = document.getElementById('dispNotes');
  const removeBtn = document.getElementById('removeDependantBtn');

  const scheduleTable = document.getElementById('scheduleTable');
  const scheduleBody = document.getElementById('scheduleBody');

  const depDosageNumber = document.getElementById('depDosageNumber');
  const depDosageUnit = document.getElementById('depDosageUnit');
  const timePickersDiv = document.getElementById('timePickers');
  const addTimeBtn = document.getElementById('addTimeBtn');

  // Open modal
  addBtn.addEventListener('click', () => {
    if(dependantAdded){
      alert("You can only add one dependant in the Basic plan.");
      return;
    }
    modal.classList.add('active');
  });

  // Close modal
  closeModalBtn.addEventListener('click', () => {
    modal.classList.remove('active');
    form.reset();
    errorMsg.textContent = '';
    timePickersDiv.innerHTML = '<input type="time" class="dose-time" required />';
    depDosageNumber.style.display = 'block';
    depDosageUnit.style.display = 'block';
  });

  // Add additional time picker
  addTimeBtn.addEventListener('click', () => {
    const newTime = document.createElement('input');
    newTime.type = 'time';
    newTime.className = 'dose-time';
    newTime.required = true;
    timePickersDiv.appendChild(newTime);
  });

  // Hide dosage unit when number typed
  depDosageNumber.addEventListener('input', () => { depDosageUnit.style.display = 'none'; });
  depDosageUnit.addEventListener('change', () => { depDosageNumber.style.display = 'none'; });

  // Handle form submit
  form.addEventListener('submit', function(e){
    e.preventDefault();

    const name = document.getElementById('depName').value;
    const medicine = document.getElementById('depMedicine').value;
    const dosageNumber = depDosageNumber.value;
    const dosageUnit = depDosageUnit.value;
    const notes = document.getElementById('depNotes').value;

    const timesInputs = Array.from(document.querySelectorAll('.dose-time'));
    if(!name || !medicine || !dosageNumber || !dosageUnit || timesInputs.some(input => !input.value)){
      errorMsg.textContent = "Please fill all required fields.";
      return;
    }

    const dosageText = `${dosageNumber} ${dosageUnit}`;

    // Display dependant info
    dispName.textContent = name;
    dispMedicine.textContent = medicine;
    dispTimes.textContent = timesInputs.map(i=>i.value).join(', ');
    dispDosage.textContent = dosageText;
    dispNotes.textContent = notes || "None";

    // Generate medication schedule
    scheduleBody.innerHTML = '';
    timesInputs.forEach((time, index) => {
      const row = document.createElement('tr');
      row.innerHTML = `<td>${index+1}</td><td>${medicine}</td><td>${dosageText}</td><td>${time.value}</td>`;
      scheduleBody.appendChild(row);
    });
    scheduleTable.style.display = 'table';

    infoBox.style.display = 'block';
    dependantAdded = true;

    // Close modal and reset
    modal.classList.remove('active');
    form.reset();
    errorMsg.textContent = '';
    depDosageNumber.style.display = 'block';
    depDosageUnit.style.display = 'block';
    timePickersDiv.innerHTML = '<input type="time" class="dose-time" required />';
  });

  // Remove dependant
  removeBtn.addEventListener('click', () => {
    if(confirm("Are you sure you want to remove this dependant?")){
      infoBox.style.display = 'none';
      scheduleTable.style.display = 'none';
      dependantAdded = false;
      timePickersDiv.innerHTML = '<input type="time" class="dose-time" required />';
    }
  });
</script>
