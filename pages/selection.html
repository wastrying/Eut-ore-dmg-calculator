
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Select Plan | Remblyx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" sizes="32x32" href="../images/medisignal.png" />
  <link rel="apple-touch-icon" href="../images/medisignal.png" />
  <style>
    * { box-sizing: border-box; margin:0; padding:0; font-family: Arial, sans-serif; }
    body { background:#f5f5f5; min-height:100vh; display:flex; justify-content:center; align-items:center; padding:16px; color:#222; position:relative; overflow:hidden; }
    .overlay { position:fixed; inset:0; z-index:-1; }
    .bg-image { width:100%; height:100%; object-fit:cover; filter:blur(4px); opacity:.8; }
    .header-row { position:fixed; top:-27px; left:8px; z-index:40; }
    .logo { height:200px; cursor:pointer; transition:.3s ease; }
    .logo:hover { filter:brightness(1.1); transform:scale(1.03); }

    .container {
      <button id="close-selection" class="close-x" aria-label="Back to dashboard" title="Back to dashboard">×</button>
      position: relative; /* for the close-X */
      background: rgba(255,255,255,.97);
      border-radius:16px;
      padding:18px 18px 16px;
      box-shadow:0 10px 26px rgba(0,0,0,.18);
      text-align:center;
      max-width: 1000px;
      width:100%;
      max-height: calc(100vh - 90px);
      overflow-y:auto;
    }

    /* Top-right "back to dashboard" X (hidden by default) */
    .close-x{
    position:absolute;
    top:10px;
    right:12px;
    width:32px;
    height:32px;
    border:none;
    border-radius:8px;
    background:#f3f4f6;
    color:#111827;
    font-size:18px;
    cursor:pointer;
    display:none; /* default hidden; shown if plan exists */
  }
  .close-x:hover{ background:#e5e7eb; }

  /* Current plan button look */
  .plan-btn.is-current,
  .plan-btn[disabled]{
    background:#9ca3af;
    cursor:not-allowed;
    opacity:0.9;
  }

    .title { font-size:24px; font-weight:600; margin-bottom:6px; }
    .subtitle { font-size:14px; color:#444; max-width:640px; margin:0 auto 10px; }
    .status { font-size:13px; color:#555; margin:6px 0 10px; }
    .plans-row { display:flex; gap:16px; justify-content:center; align-items:stretch; flex-wrap:wrap; }
    .plan-card {
      flex:1 1 260px; max-width:320px; background:rgba(250,250,250,.98);
      border-radius:16px; padding:16px 14px 14px; box-shadow:0 8px 20px rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.9); display:flex; flex-direction:column; cursor:pointer; transition:.25s;
    }
    .plan-card:hover { transform:translateY(-3px); box-shadow:0 10px 26px rgba(0,0,0,.22); }
    .plan-card.active { border:2px solid #667eea; box-shadow:0 12px 30px rgba(102,126,234,.35); }
    .plan-label { font-size:11px; font-weight:600; text-transform:uppercase; letter-spacing:.06em; color:#888; margin-bottom:3px; }
    .plan-name { font-size:19px; font-weight:600; color:#222; margin-bottom:4px; }
    .plan-tagline { font-size:12px; color:#666; margin-bottom:8px; }
    .plan-features { list-style:none; padding-left:0; margin:0 0 10px; font-size:12px; color:#444; text-align:left; }
    .plan-features li { margin-bottom:4px; }
    .plan-btn { margin-top:auto; align-self:stretch; padding:9px 10px; border-radius:10px; border:none; cursor:pointer; font-size:13px; font-weight:500; color:#fff; background:linear-gradient(135deg,#667eea,#764ba2); transition:.25s; }
    .plan-btn:hover { opacity:.96; transform:translateY(-1px); }

    /* Highlight current plan's button */
    .plan-btn.is-current,
    .plan-btn[disabled]{
      background:#9ca3af;
      cursor:not-allowed;
      opacity:0.9;
    }
  </style>
</head>
<body>
  <div class="overlay"><img src="../images/background.png" class="bg-image" alt=""></div>

  <div class="header-row">
    <img src="../images/remblyxlogo.png" alt="Remblyx" class="logo" onclick="window.location.href='../index.html'">
  </div>

  <div class="container">
    <!-- close to dashboard (only shown if user already has a plan) -->
    <button id="close-to-dashboard" class="close-x" title="Back to dashboard" aria-label="Back to dashboard">×</button>

    <div class="title">Choose your Remblyx plan</div>
    <div class="subtitle">Pick a workspace level below. We’ll remember it for your account and show a tailored dashboard next time you log in.</div>
    <div id="status" class="status">Checking your current plan...</div>

    <div class="plans-row" id="plans">
      <div class="plan-card" data-plan="Basic">
        <div class="plan-label">Plan</div>
        <div class="plan-name">Basic</div>
        <div class="plan-tagline">For simple personal or student use.</div>
        <ul class="plan-features">
          <li>✔ Core monitoring tools</li><li>✔ Limited alerts</li><li>✔ 1 workspace</li>
        </ul>
        <button class="plan-btn">Use Basic</button>
      </div>

      <div class="plan-card" data-plan="Premium">
        <div class="plan-label">Recommended</div>
        <div class="plan-name">Premium</div>
        <div class="plan-tagline">For teams that need more control.</div>
        <ul class="plan-features">
          <li>✔ Everything in Basic</li><li>✔ Priority alerts</li><li>✔ Team collaboration</li><li>✔ Higher limits</li>
        </ul>
        <button class="plan-btn">Use Premium</button>
      </div>

      <div class="plan-card" data-plan="Enterprise">
        <div class="plan-label">Advanced</div>
        <div class="plan-name">Enterprise</div>
        <div class="plan-tagline">For full-scale deployments &amp; integrations.</div>
        <ul class="plan-features">
          <li>✔ All Premium features</li><li>✔ API &amp; webhooks</li><li>✔ Audit logs</li><li>✔ Priority support</li>
        </ul>
        <button class="plan-btn">Use Enterprise</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  // --- Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyAEosHpiAT72yIIvaT1a8-lAXwsw-mR3i8",
    authDomain: "remblyx-medisignal.firebaseapp.com",
    projectId: "remblyx-medisignal",
    storageBucket: "remblyx-medisignal.appspot.com",
    messagingSenderId: "50711670199",
    appId: "1:50711670199:web:0c9c2ff72cd77234ce0c32",
    measurementId: "G-JQ3843RM4V"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // --- Elements
  const planCards = document.querySelectorAll(".plan-card");
  const statusEl  = document.getElementById("status");
  const closeBtn  = document.getElementById("close-selection");

  // --- Helpers
  const DASHBOARD_URL = "./dashboard.html";
  const MODE = (new URLSearchParams(location.search).get("mode") || "new").toLowerCase(); // "new" or "change"
  const DEV_EMAILS = ["medisignal.remblyx@gmail.com"];

  let currentUser = null;
  let savedPlan = null;

  function setStatus(text){ if (statusEl) statusEl.textContent = text; }

  function highlightPlanCard(plan) {
    planCards.forEach(card => {
      card.classList.toggle("active", card.getAttribute("data-plan") === plan);
    });
  }

  function markCurrentPlanButton(plan){
    planCards.forEach(card => {
      const name = card.getAttribute("data-plan");
      const btn  = card.querySelector(".plan-btn");
      if (!btn) return;

      if (name === plan){
        btn.textContent = "Currently using";
        btn.classList.add("is-current");
        btn.setAttribute("disabled", "disabled");
        // Ignore clicks on the current card
        card.onclick = (e) => e.stopPropagation();
      } else {
        btn.textContent = `Use ${name}`;
        btn.classList.remove("is-current");
        btn.removeAttribute("disabled");
      }
    });
  }

  function bindPlanClicks(user) {
    planCards.forEach(card => {
      const name = card.getAttribute("data-plan");
      const btn  = card.querySelector(".plan-btn");

      if (name === savedPlan) return; // already marked and disabled

      const select = async (e) => {
        e?.stopPropagation?.();
        if (MODE === "change" && savedPlan && savedPlan !== name) {
          const ok = confirm(`Switch plan from ${savedPlan} ➜ ${name}?`);
          if (!ok) return;
        }
        try {
          await setDoc(doc(db, "users", user.uid), { email: user.email || null, plan: name }, { merge: true });
          // Guard flag to stop bounce on first dashboard load
          sessionStorage.setItem("rbx_last_nav", "from_selection");
          window.location.href = `${DASHBOARD_URL}?from=selection`;
        } catch (e) {
          alert("Couldn't save plan. Check Firestore rules/console.");
          console.error(e);
        }
      };

      card.addEventListener("click", select);
      if (btn) btn.addEventListener("click", select);
    });
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "./login.html";
      return;
    }
    currentUser = user;

    // Dev accounts never stay here; force Developers and go
    if (DEV_EMAILS.includes((user.email || "").toLowerCase())) {
      try {
        await setDoc(doc(db, "users", user.uid), { email: user.email || null, plan: "Developers" }, { merge: true });
      } finally {
        sessionStorage.setItem("rbx_last_nav", "from_selection");
        window.location.href = `${DASHBOARD_URL}?from=selection`;
      }
      return;
    }

    // Load existing plan (if any)
    try {
      const snap = await getDoc(doc(db, "users", user.uid));
      savedPlan = snap.exists() ? snap.data().plan : null;
    } catch (e) {
      console.error("Error loading plan:", e);
      // Stay on selection (don’t bounce) so user can choose a plan to recover
      savedPlan = null;
    }

    // If a plan exists and user didn't explicitly open "change" mode, go straight to dashboard.
    if (savedPlan && MODE !== "change") {
      sessionStorage.setItem("rbx_last_nav", "from_selection");
      window.location.href = `${DASHBOARD_URL}?from=selection`;
      return;
    }

    // Show close X only if user already has a plan
    if (closeBtn) {
      if (savedPlan) {
        closeBtn.style.display = "inline-block";
        closeBtn.onclick = () => {
          sessionStorage.setItem("rbx_last_nav", "from_selection");
          window.location.href = `${DASHBOARD_URL}?from=selection`;
        };
      } else {
        closeBtn.style.display = "none";
      }
    }

    // Stay on selection page; show state + disable current button
    if (savedPlan) {
      highlightPlanCard(savedPlan);
      markCurrentPlanButton(savedPlan);
      setStatus(`Current plan: ${savedPlan}. Choose a new plan to switch.`);
    } else {
      setStatus("No plan selected yet. Choose one to continue.");
    }

    bindPlanClicks(user);
  });
</script>
</body>
</html>
