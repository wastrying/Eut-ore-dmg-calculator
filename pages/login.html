<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Log In | Remblyx</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="../images/medisignal.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../images/medisignal.png">
  <link rel="apple-touch-icon" href="../images/medisignal.png">

  <!-- Flaticon icons for eye / eye-crossed -->
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
    body { background: #ffffff; min-height: 100vh; display: flex; justify-content: center; align-items: center; position: relative; overflow: hidden; padding: 16px; }
    .overlay { position: fixed; inset: 0; z-index: -1; }
    .bg-image { width: 100%; height: 100%; object-fit: cover; filter: blur(4px); opacity: 0.8; }
    .header-row { position: fixed; top: -27px; left: 8px; z-index: 20; }
    .logo { height: 200px; cursor: pointer; transition: 0.3s ease; }
    .logo:hover { filter: brightness(1.1); transform: scale(1.03); }
    .container { background: rgba(245, 245, 245, 0.97); border-radius: 16px; padding: 20px 18px 18px; max-width: 420px; width: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.2); color: #333; z-index: 10; text-align: center; margin: 0; max-height: calc(100vh - 80px); overflow-y: auto; }
    h2 { margin-bottom: 12px; color: #333; font-size: 22px; font-weight: 600; }
    .social-buttons { display: flex; gap: 10px; margin-bottom: 14px; }
    .social-btn { flex: 1; padding: 8px; border: none; border-radius: 8px; cursor: pointer; font-size: 13px; display: flex; align-items: center; justify-content: center; transition: 0.25s; color: #fff; touch-action: manipulation; }
    .gmail-btn { background: #e57373; }
    .facebook-btn { background: #4267B2; }
    .social-btn img { height: 18px; width: 18px; margin-right: 6px; }
    .social-btn:hover { opacity: 0.92; transform: translateY(-1px); }
    hr { margin: 10px 0 12px; border: 0; border-top: 1px solid #ccc; }
    input[type="text"], input[type="password"] { width: 100%; padding: 10px; margin: 6px 0; border-radius: 8px; border: 1px solid #ccc; font-size: 14px; background: #fff; color: #333; }
    input::placeholder { color: #999; }
    .password-wrapper { position: relative; width: 100%; margin: 6px 0; }
    .password-wrapper input { margin: 0; padding-right: 38px; }
    .toggle-password { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); border: none; background: transparent; cursor: pointer; font-size: 18px; color: #777; padding: 0; line-height: 1; display: flex; align-items: center; justify-content: center; user-select: none; }
    .toggle-password:hover { color: #333; }
    button.submit-btn { width: 100%; padding: 11px; margin-top: 10px; border: none; border-radius: 10px; font-size: 15px; cursor: pointer; background: linear-gradient(135deg, #667eea, #764ba2); color: #fff; transition: 0.25s; touch-action: manipulation; }
    button.submit-btn:hover { opacity: 0.94; transform: translateY(-1px); }
    .error { color: red; font-size: 12px; margin-top: 5px; min-height: 16px; }
    .create-text { margin-top: 10px; font-size: 13px; color: #555; }
    .create-text a { color: #555; font-weight: bold; text-decoration: underline; }
    #home-box { display: none; }
    @media (max-width: 480px) {
      body { padding: 10px; }
      .logo { height: 115px; }
      .header-row { top: -10px; }
      .container { padding: 18px 14px 14px; border-radius: 14px; }
      h2 { font-size: 20px; }
      .social-btn { font-size: 12px; padding: 7px; }
      button.submit-btn { font-size: 14px; padding: 10px; }
    }
  </style>
</head>
<body>

  <div class="overlay">
    <img src="../images/background.png" alt="Background" class="bg-image">
  </div>

  <div class="header-row">
    <img src="../images/remblyxlogo.png" alt="Logo" class="logo" onclick="window.location.href='../index.html'">
  </div>

  <div id="login-box" class="container">
    <h2>Log In</h2>

    <div class="social-buttons">
      <button type="button" class="social-btn gmail-btn">
        <img src="https://img.icons8.com/color/48/000000/google-logo.png" alt="Gmail Icon">Gmail
      </button>
      <button type="button" class="social-btn facebook-btn">
        <img src="https://img.icons8.com/color/48/000000/facebook-new.png" alt="Facebook Icon">Facebook
      </button>
    </div>

    <hr>

    <p id="error" class="error"></p>
    <form id="loginForm">
      <input type="text" id="email" placeholder="Email" required>
      <div class="password-wrapper">
        <input type="password" id="password" placeholder="Password" required>
        <button type="button" id="toggle-password" class="toggle-password" aria-label="Hold to show password">
          <i id="password-eye-icon" class="fi fi-rr-eye-crossed"></i>
        </button>
      </div>

      <button type="submit" class="submit-btn">Log In</button>
    </form>

    <p class="create-text">
      Are you a new user? <a href="./signup.html">Create your account</a>
    </p>
  </div>

  <div id="home-box" class="container">
    <h2>Welcome!</h2>
    <p id="welcome-text"></p>
    <button id="logoutBtn">Logout</button>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import {
    getAuth,
    signInWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    GoogleAuthProvider,
    FacebookAuthProvider,
    signInWithPopup,
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    collection,
    getDocs,
    query,
    where,
    deleteField
  } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAEosHpiAT72yIIvaT1a8-lAXwsw-mR3i8",
    authDomain: "remblyx-medisignal.firebaseapp.com",
    projectId: "remblyx-medisignal",
    storageBucket: "remblyx-medisignal.appspot.com",
    messagingSenderId: "50711670199",
    appId: "1:50711670199:web:0c9c2ff72cd77234ce0c32",
    measurementId: "G-JQ3843RM4V"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);

  const loginBox   = document.getElementById("login-box");
  const homeBox    = document.getElementById("home-box");
  const form       = document.getElementById("loginForm");
  const errorText  = document.getElementById("error");
  const gmailBtn   = document.querySelector(".gmail-btn");
  const facebookBtn= document.querySelector(".facebook-btn");
  const logoutBtn  = document.getElementById("logoutBtn");

  const passwordInput    = document.getElementById("password");
  const togglePasswordBtn= document.getElementById("toggle-password");
  const passwordEyeIcon  = document.getElementById("password-eye-icon");

  const googleProvider   = new GoogleAuthProvider();
  const facebookProvider = new FacebookAuthProvider();
  let popupInProgress    = false;

  // ===== PLAN / MEMBERSHIP HELPERS =====

  const DEV_EMAILS = ["medisignal.remblyx@gmail.com"];
  const normalizeEmail = (s) => (s || "").trim().toLowerCase();

  function redirectByPlan(plan){
    if (plan === "Basic")          window.location.href = "./basic_plan.html";
    else if (plan === "Premium")   window.location.href = "./premium_plan.html";
    else if (plan === "Enterprise")window.location.href = "./enterprise_plan.html";
    else if (plan === "Developers")window.location.href = "./developer_plan.html";
    else                           window.location.href = "./basic_plan.html"; // fallback
  }

  async function loadUserPlan(user){
    try {
      const ref  = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? (snap.data() || {}) : {};
      const emailLower = normalizeEmail(user.email);

      // New / missing doc
      if (!data.plan){
        const base = data.basePlan || "Basic";
        await setDoc(ref, {
          email: emailLower,
          plan: base,
          basePlan: base
        }, { merge:true });
        return base;
      }

      // Backfill basePlan / normalised email
      const updates = {};
      if (!data.basePlan) updates.basePlan = data.plan;
      if (data.email !== emailLower) updates.email = emailLower;

      if (Object.keys(updates).length){
        await setDoc(ref, updates, { merge:true });
      }

      return data.plan;
    } catch (e){
      console.warn("loadUserPlan failed, defaulting to Basic", e);
      return "Basic";
    }
  }

  async function ensureDevelopersPlanIfAllowed(user){
    const emailLower = normalizeEmail(user.email);
    const isDev = DEV_EMAILS.includes(emailLower);
    if (!isDev) return null;

    try {
      const ref  = doc(db,"users",user.uid);
      const snap = await getDoc(ref);
      const data = snap.exists() ? (snap.data() || {}) : {};

      if (data.plan === "Developers"){
        if (data.email !== emailLower){
          await setDoc(ref, { email: emailLower }, { merge:true });
        }
        return "Developers";
      }

      await setDoc(ref, {
        email: emailLower,
        plan: "Developers",
        basePlan: "Developers"
      }, { merge:true });

      return "Developers";
    } catch (e){
      console.warn("ensureDevelopersPlanIfAllowed failed", e);
      return null;
    }
  }

  async function maybeApplyInboundMembership(user, currentLoadedPlan){
    try {
      const memberEmail = normalizeEmail(user.email);

      const userRef  = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      const userData = userSnap.exists() ? (userSnap.data() || {}) : {};

      const basePlan =
        userData.basePlan ||
        currentLoadedPlan ||
        userData.plan ||
        "Basic";

      // plan_links where this user is the member
      const qLinks = query(
        collection(db, "plan_links"),
        where("memberEmail", "==", memberEmail)
      );
      const snap = await getDocs(qLinks);

      const activeLinks = snap.docs.filter(d => {
        const f = d.data() || {};
        return f.isActive !== false && !!f.plan;
      });

      // No active membership → restore base plan
      if (activeLinks.length === 0) {
        if (
          userData.plan !== basePlan ||
          userData.basePlan !== basePlan ||
          userData.activeLinkId
        ) {
          await setDoc(
            userRef,
            {
              plan: basePlan,
              basePlan: basePlan,
              activeLinkId: deleteField()
            },
            { merge: true }
          );
        }
        return basePlan;
      }

      // Use first membership link
      const first = activeLinks[0];
      const f     = first.data() || {};
      const membershipPlan = f.plan || basePlan;

      await setDoc(
        userRef,
        {
          plan:         membershipPlan,
          basePlan:     basePlan,
          activeLinkId: first.id
        },
        { merge: true }
      );

      return membershipPlan;
    } catch (err) {
      console.warn("inbound membership check failed", err);
      return currentLoadedPlan;
    }
  }

  /** Main entry called on login + onAuthStateChanged */
  async function ensurePlanOnLogin(user){
    // 1) Dev override (for your own dev account)
    const forced = await ensureDevelopersPlanIfAllowed(user);

    // 2) Ensure /users doc + plan
    let plan = forced || await loadUserPlan(user);

    // 3) If not forced, apply membership from /plan_links
    if (!forced){
      plan = await maybeApplyInboundMembership(user, plan);
    }

    return plan; // e.g. "Enterprise"
  }

  // ===== UI helpers =====

  const showError = (msg) => { errorText.textContent = msg; };
  const clearError = () => { errorText.textContent = ""; };

  const showLogin = () => {
    loginBox.style.display = "block";
    if (homeBox) homeBox.style.display = "none";
    clearError();
    form.reset();
  };

  // ===== HANDLE AUTH STATE (including direct visiting /login) =====
  const handleVerifiedOrBlock = async (user) => {
    if (!user) {
      showLogin();
      return;
    }

    const isPasswordUser = user.providerData.some(p => p.providerId === "password");
    if (isPasswordUser && !user.emailVerified) {
      showError("Please verify your email before logging in.");
      await signOut(auth);
      showLogin();
      return;
    }

    // Verified or OAuth → ensure plan + membership, then redirect
    try {
      const finalPlan = await ensurePlanOnLogin(user);
      redirectByPlan(finalPlan);
    } catch (e) {
      console.error("Plan / membership flow failed:", e);
      redirectByPlan("Basic");
    }
  };

  onAuthStateChanged(auth, (user) => {
    // Any time auth state changes, re-run logic
    handleVerifiedOrBlock(user);
  });

  // ===== Hold-to-show password with caret preserved =====
  if (togglePasswordBtn && passwordInput && passwordEyeIcon) {
    let lastSelection = { start: null, end: null };
    const rememberSelection = () => {
      try {
        lastSelection.start = passwordInput.selectionStart;
        lastSelection.end   = passwordInput.selectionEnd;
      } catch {
        lastSelection.start = lastSelection.end = null;
      }
    };
    const restoreSelection = () => {
      if (
        lastSelection.start !== null &&
        lastSelection.end   !== null &&
        document.activeElement === passwordInput
      ) {
        requestAnimationFrame(() => {
          try {
            passwordInput.setSelectionRange(lastSelection.start, lastSelection.end);
          } catch {}
        });
      }
    };
    const showPassword = () => {
      rememberSelection();
      passwordInput.type = "text";
      passwordInput.focus();
      restoreSelection();
      passwordEyeIcon.classList.remove("fi-rr-eye-crossed");
      passwordEyeIcon.classList.add("fi-rr-eye");
    };
    const hidePassword = () => {
      rememberSelection();
      passwordInput.type = "password";
      passwordInput.focus();
      restoreSelection();
      passwordEyeIcon.classList.remove("fi-rr-eye");
      passwordEyeIcon.classList.add("fi-rr-eye-crossed");
    };
    ["mousedown", "touchstart"].forEach(evt => {
      togglePasswordBtn.addEventListener(
        evt,
        (e) => { e.preventDefault(); showPassword(); },
        { passive: false }
      );
    });
    ["mouseup", "mouseleave", "touchend", "touchcancel"].forEach(evt => {
      window.addEventListener(evt, () => {
        if (passwordInput.type === "text") hidePassword();
      });
    });
  }

  // ===== Email/password login =====
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    clearError();

    const email    = document.getElementById("email").value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
      showError("⚠ Please fill in all fields.");
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      // After this, onAuthStateChanged → handleVerifiedOrBlock → ensurePlanOnLogin → redirect
    } catch (error) {
      console.error("Login error:", error);
      let message = "⚠ Invalid email or password.";
      if (error.code === "auth/invalid-email")          message = "⚠ Invalid email format.";
      else if (error.code === "auth/user-not-found")    message = "⚠ No account found with this email.";
      else if (error.code === "auth/wrong-password")    message = "⚠ Incorrect password.";
      else if (error.code === "auth/too-many-requests") message = "⚠ Too many attempts. Try again later.";
      showError(message);
    }
  });

  // Optional logout (if you ever show homeBox)
  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
      showLogin();
    });
  }

  // ===== Google login =====
  gmailBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (popupInProgress) return;
    popupInProgress = true;
    clearError();
    try {
      await signInWithPopup(auth, googleProvider);
      // onAuthStateChanged will handle plan + redirect
    } catch (error) {
      if (error.code !== "auth/cancelled-popup-request") {
        console.error("Google login error:", error);
        showError("⚠ Google sign-in failed.");
      }
    } finally {
      popupInProgress = false;
    }
  });

  // ===== Facebook login =====
  facebookBtn.addEventListener("click", async (e) => {
    e.preventDefault();
    if (popupInProgress) return;
    popupInProgress = true;
    clearError();
    try {
      await signInWithPopup(auth, facebookProvider);
      // onAuthStateChanged will handle plan + redirect
    } catch (error) {
      if (error.code !== "auth/cancelled-popup-request") {
        console.error("Facebook login error:", error);
        showError("⚠ Facebook sign-in failed.");
      }
    } finally {
      popupInProgress = false;
    }
  });
</script>
</body>
</html>


